<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMessage Social ‚Äî Polished</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary-color:#007AFF;
      --secondary-color:#5856D6;
      --bg-color:#F2F2F7;
      --card-bg:rgba(255,255,255,0.8);
      --text-color:#1C1C1E;
      --border-radius:20px;
      --shadow:0 12px 48px rgba(31,38,135,0.37);
      --transition:all 0.28s cubic-bezier(0.25,0.46,0.45,0.94);
      --glass-bg:rgba(255,255,255,0.25);
      --glass-border:rgba(255,255,255,0.18);
    }

    [data-theme="dark"]{
      --bg-color:#000;
      --card-bg:rgba(30,30,30,0.7);
      --text-color:#fff;
      --glass-bg:rgba(30,30,30,0.5);
      --glass-border:rgba(255,255,255,0.1);
    }

    [data-theme="liquid"]{
      --bg-color:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --card-bg:rgba(255,255,255,0.12);
      --text-color:#fff;
      --glass-bg:rgba(255,255,255,0.08);
      --glass-border:rgba(255,255,255,0.12);
    }

    [data-theme="sunset"]{
      --bg-color:linear-gradient(135deg,#ff7e5f 0%,#feb47b 100%);
      --card-bg:rgba(255,255,255,0.12);
      --text-color:#fff;
      --glass-bg:rgba(255,255,255,0.12);
      --glass-border:rgba(255,255,255,0.16);
    }

    [data-theme="forest"]{
      --bg-color:linear-gradient(135deg,#0ba360 0%,#3cba92 100%);
      --card-bg:rgba(255,255,255,0.12);
      --text-color:#fff;
      --glass-bg:rgba(255,255,255,0.08);
      --glass-border:rgba(255,255,255,0.12);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,Cantarell,sans-serif}
    html,body{height:100%}
    body{
      background:var(--bg-color);
      color:var(--text-color);
      transition:var(--transition);
      min-height:100vh;
      overflow:hidden;
      padding:20px;
    }

    /* layout */
    .container{max-width:1200px;margin:0 auto;display:flex;gap:20px;height:calc(100vh - 40px)}
    .sidebar{
      width:320px;background:var(--glass-bg);backdrop-filter:blur(14px);border:1px solid var(--glass-border);border-radius:var(--border-radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column
    }
    .content{flex:1;display:flex;flex-direction:column;background:var(--glass-bg);backdrop-filter:blur(14px);border:1px solid var(--glass-border);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden}
    .title{font-weight:700;font-size:20px;margin-bottom:12px;text-align:center;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{flex:1;padding:8px;border-radius:10px;text-align:center;cursor:pointer;font-size:13px;background:rgba(255,255,255,0.08)}
    .tab.active{background:var(--primary-color);color:#fff;transform:scale(1.03)}

    .search{padding:10px;border-radius:12px;border:1px solid var(--glass-border);margin-bottom:10px;background:rgba(255,255,255,0.06);color:var(--text-color)}
    .list{overflow:auto;flex:1;padding-right:6px}
    .item{display:flex;align-items:center;padding:12px;border-radius:12px;margin-bottom:10px;cursor:pointer;transition:var(--transition)}
    .item:hover{transform:translateY(-3px);background:rgba(255,255,255,0.03)}
    .avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:12px;background:linear-gradient(135deg,#5856D6,#007AFF);color:#fff;flex-shrink:0;position:relative;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .status{position:absolute;right:2px;bottom:2px;width:10px;height:10px;border-radius:50%;border:2px solid var(--card-bg);background:#34C759}
    .status.offline{background:#8E8E93}

    .info h4{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .info p{font-size:13px;color:#8E8E93;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* chat area */
    .chat-header{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--glass-border);gap:12px}
    .chat-body{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .messages{padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:70%;padding:12px 14px;border-radius:16px;word-wrap:break-word;animation:fadeIn .18s ease}
    .msg.sent{align-self:flex-end;background:var(--primary-color);color:#fff;border-bottom-right-radius:6px}
    .msg.received{align-self:flex-start;background:#E5E5EA;color:#000;border-bottom-left-radius:6px}
    .meta{font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px;text-align:right}
    .footer{padding:14px;border-top:1px solid var(--glass-border);display:flex;gap:10px;align-items:center}
    .input{flex:1;padding:12px 14px;border-radius:20px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.06);color:var(--text-color);outline:none}
    .btn-send{width:44px;height:44px;border-radius:50%;border:none;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}

    /* profile card */
    .profile-card{position:relative;width:260px;background:var(--glass-bg);backdrop-filter:blur(14px);border:1px solid var(--glass-border);border-radius:12px;padding:12px;margin-left:auto;box-shadow:var(--shadow)}
    .profile-row{display:flex;gap:12px;align-items:center}
    .profile-row h3{font-size:16px}
    .stats{display:flex;gap:10px;margin-top:10px;font-size:13px;color:#8E8E93;justify-content:space-between}
    .profile-actions{display:flex;gap:8px;margin-top:12px}

    /* modal style for profile edit */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:999}
    .modal.open{display:flex}
    .modal-body{background:var(--glass-bg);border:1px solid var(--glass-border);padding:18px;border-radius:14px;width:92%;max-width:480px;box-shadow:var(--shadow)}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    @media (max-width:800px){
      .container{flex-direction:column;height:auto}
      .sidebar{width:100%;height:auto}
      .content{width:100%;height:calc(100vh - 260px)}
    }
  </style>
</head>
<body data-theme="light">
  <!-- Login (kept simple here) -->
  <div id="login" style="display:none">
    <!-- placeholder if you want an overlay login -->
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="title">iMessage Social</div>

      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div class="avatar" id="smallProfilePic"><i class="fas fa-user"></i></div>
        <div style="flex:1">
          <div id="smallProfileName">Loading...</div>
          <div id="smallProfileBio" style="font-size:12px;color:#8E8E93">Bio will appear here</div>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="chats">üí¨ Chats</div>
        <div class="tab" data-tab="suggested">üë• Suggested</div>
        <div class="tab" data-tab="followed">‚ù§Ô∏è Followed</div>
        <div class="tab" data-tab="me">üôç Me</div>
      </div>

      <input class="search" id="searchBox" placeholder="Search users or messages">

      <div class="list" id="listArea">
        <!-- list items (users/chats/followed) -->
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="editProfileBtn" class="btn" style="flex:1;padding:8px;border-radius:10px;background:var(--primary-color);color:#fff;border:none">Edit Profile</button>
        <button id="logoutBtn" class="btn" style="padding:8px;border-radius:10px;background:transparent;border:1px solid var(--primary-color);color:var(--primary-color)">Logout</button>
      </div>
    </div>

    <div class="content">
      <div class="chat-header" id="chatHeader">
        <div class="avatar" id="chatHeaderAvatar"><i class="fas fa-user-friends"></i><div class="status offline" id="chatHeaderStatus"></div></div>
        <div>
          <div id="chatTitle"><strong>Select a conversation</strong></div>
          <div id="chatSubtitle" style="font-size:13px;color:#8E8E93">Start chatting with friends</div>
        </div>
      </div>

      <div class="chat-body">
        <div class="messages" id="messages">
          <div class="msg received">
            Welcome to iMessage Social! Select a conversation to start messaging.
            <div class="meta">Just now</div>
          </div>
        </div>

        <div class="footer">
          <input id="messageInput" class="input" placeholder="Type a message‚Ä¶" autocomplete="off">
          <button id="sendBtn" class="btn-send"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit profile modal -->
  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-body" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Edit Profile</h3>
        <button id="closeModal" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
      </div>

      <label style="font-weight:600;display:block;margin-bottom:6px">Display name</label>
      <input id="editName" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass-border);margin-bottom:10px">

      <label style="font-weight:600;display:block;margin-bottom:6px">Bio (max 10 words)</label>
      <textarea id="editBio" rows="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass-border)"></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <small id="wordCount" style="color:#8E8E93">10 words remaining</small>
        <button id="saveProfile" style="padding:8px 12px;background:var(--primary-color);border:none;color:#fff;border-radius:8px">Save</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      query,
      where,
      orderBy,
      updateDoc,
      doc,
      setDoc,
      getDoc,
      getDocs,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // CONFIG - replace with your own Firebase config if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCvaWRvpDY-BOOg_oitS4oVGDoQkiWMR6A",
      authDomain: "windowsassistant-36760.firebaseapp.com",
      projectId: "windowsassistant-36760",
      storageBucket: "windowsassistant-36760.firebasestorage.app",
      messagingSenderId: "125638102938",
      appId: "1:125638102938:web:42e36690e0b74096003423"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // DOM
    const listArea = document.getElementById('listArea');
    const tabs = document.querySelectorAll('.tab');
    const searchBox = document.getElementById('searchBox');

    const smallProfilePic = document.getElementById('smallProfilePic');
    const smallProfileName = document.getElementById('smallProfileName');
    const smallProfileBio = document.getElementById('smallProfileBio');

    const editProfileBtn = document.getElementById('editProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const editModal = document.getElementById('editModal');
    const closeModal = document.getElementById('closeModal');
    const editName = document.getElementById('editName');
    const editBio = document.getElementById('editBio');
    const wordCount = document.getElementById('wordCount');
    const saveProfile = document.getElementById('saveProfile');

    const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
    const chatHeaderStatus = document.getElementById('chatHeaderStatus');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');

    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    let sendBtn = document.getElementById('sendBtn'); // "let" to allow re-assign if needed

    // State
    let currentUser = null;
    let users = []; // other users list
    let follows = [];
    let chats = []; // local cache of messages
    let currentChatUser = null;

    // helpers
    const formatTime = ts => {
      if(!ts) return 'Just now';
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      } catch { return 'Just now' }
    };

    // UI helpers
    function safeSetProfile(picEl, nameEl, bioEl, userData){
      nameEl.textContent = userData.displayName || 'User';
      bioEl.textContent = userData.bio || 'Bio will appear here';
      if(userData.photoURL){
        picEl.innerHTML = `<img src="${userData.photoURL}" alt="profile">` + `<div class="status" id="miniStatus"></div>`;
      } else {
        picEl.innerHTML = `<i class="fas fa-user"></i>` + `<div class="status" id="miniStatus"></div>`;
      }
    }

    // Modal: word count
    function updateWordCount(){
      const words = editBio.value.trim().split(/\s+/).filter(Boolean);
      const left = Math.max(0, 10 - words.length);
      wordCount.textContent = `${left} words remaining`;
      wordCount.style.color = left === 0 ? '#FF3B30' : '#8E8E93';
      if(words.length > 10){
        editBio.value = words.slice(0,10).join(' ');
      }
    }
    editBio.addEventListener('input', updateWordCount);

    // modal open/close
    editProfileBtn.addEventListener('click', ()=> {
      editName.value = smallProfileName.textContent || '';
      editBio.value = smallProfileBio.textContent || '';
      updateWordCount();
      editModal.classList.add('open');
      editModal.setAttribute('aria-hidden','false');
      editName.focus();
    });
    closeModal.addEventListener('click', ()=> {
      editModal.classList.remove('open');
      editModal.setAttribute('aria-hidden','true');
    });

    saveProfile.addEventListener('click', async ()=> {
      const newName = editName.value.trim();
      const bioWords = editBio.value.trim().split(/\s+/).filter(Boolean).slice(0,10).join(' ');
      if(currentUser){
        const ref = doc(db, 'users', currentUser.uid);
        await updateDoc(ref, { displayName: newName, bio: bioWords }).catch(console.error);
      }
      smallProfileName.textContent = newName || smallProfileName.textContent;
      smallProfileBio.textContent = bioWords || smallProfileBio.textContent;
      editModal.classList.remove('open');
    });

    logoutBtn.addEventListener('click', async ()=> {
      if(currentUser){
        const ref = doc(db, 'users', currentUser.uid);
        await updateDoc(ref, { isOnline: false, lastSeen: serverTimestamp() }).catch(() => {});
      }
      signOut(auth).catch(console.error);
    });

    // Tabs
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        renderList(name);
      });
    });

    // Search
    searchBox.addEventListener('input', () => {
      const active = document.querySelector('.tab.active').dataset.tab;
      renderList(active, searchBox.value.trim());
    });

    // Firestore listeners
    onAuthStateChanged(auth, async user => {
      if(user){
        currentUser = user;
        // show UI (we always show - login handled externally)
        // ensure profile exists
        await ensureProfile(user);
        // load theme and profile
        const userDoc = await getDoc(doc(db,'users',user.uid));
        if(userDoc.exists()){
          safeSetProfile(smallProfilePic, smallProfileName, smallProfileBio, userDoc.data());
          if(userDoc.data().theme) document.body.setAttribute('data-theme', userDoc.data().theme);
        }
        // set online
        await updateDoc(doc(db,'users',user.uid), { isOnline: true, lastSeen: serverTimestamp() }).catch(()=>{});
        // watchers
        startUsersListener();
        startFollowsListener();
        startMessagesListener();
      } else {
        currentUser = null;
        // UI fallback (not hiding in this file)
      }
    });

    async function ensureProfile(user){
      const ref = doc(db,'users',user.uid);
      const snapshot = await getDoc(ref);
      if(!snapshot.exists()){
        await setDoc(ref, {
          displayName: user.displayName || `User${Math.floor(1000 + Math.random()*9000)}`,
          bio: 'Hello! I am using iMessage Social.',
          photoURL: user.photoURL || '',
          followers: 0,
          following: 0,
          isOnline: true,
          lastSeen: serverTimestamp(),
          createdAt: serverTimestamp(),
          theme: 'light'
        });
      }
    }

    // Users listener
    let usersUnsub = null;
    function startUsersListener(){
      if(usersUnsub) usersUnsub();
      const q = collection(db,'users');
      usersUnsub = onSnapshot(q, snap => {
        users = [];
        snap.forEach(d => {
          if(d.id !== (currentUser && currentUser.uid)) users.push({ id: d.id, ...d.data() });
        });
        // re-render current list tab
        const active = document.querySelector('.tab.active').dataset.tab;
        renderList(active);
      });
    }

    // Follows listener
    let followsUnsub = null;
    function startFollowsListener(){
      if(!currentUser) return;
      if(followsUnsub) followsUnsub();
      const q = query(collection(db,'follows'), where('followerId','==',currentUser.uid));
      followsUnsub = onSnapshot(q, snap => {
        follows = [];
        snap.forEach(d => follows.push({ id: d.id, ...d.data() }));
        // update following count in UI
        // re-render lists
        const active = document.querySelector('.tab.active').dataset.tab;
        renderList(active);
      });
    }

    // Messages listener (two queries merged safely)
    let messagesUnsub = null;
    function startMessagesListener(){
      if(!currentUser) return;
      if(messagesUnsub) messagesUnsub();

      // We'll listen for messages where current user is sender OR receiver.
      const q1 = query(collection(db,'messages'), where('senderId','==',currentUser.uid), orderBy('timestamp','asc'));
      const q2 = query(collection(db,'messages'), where('receiverId','==',currentUser.uid), orderBy('timestamp','asc'));

      // Merge updates from both queries into local `chats` (avoid duplicate ids)
      const localMap = new Map();

      const updateFromSnapshot = (snap) => {
        snap.forEach(d => {
          localMap.set(d.id, { id: d.id, ...d.data() });
        });
      };

      const unsub1 = onSnapshot(q1, snap => {
        updateFromSnapshot(snap);
        chats = Array.from(localMap.values()).sort((a,b)=> {
          const ta = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
          const tb = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
          return ta - tb;
        });
        renderList('chats');
        if(currentChatUser) loadChatMessages(currentChatUser.id);
      });

      const unsub2 = onSnapshot(q2, snap => {
        updateFromSnapshot(snap);
        chats = Array.from(localMap.values()).sort((a,b)=> {
          const ta = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
          const tb = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
          return ta - tb;
        });
        renderList('chats');
        if(currentChatUser) loadChatMessages(currentChatUser.id);
      });

      messagesUnsub = ()=>{
        unsub1(); unsub2();
      };
    }

    // Render lists: chats / suggested / followed
    function renderList(tabName, filter=''){
      listArea.innerHTML = '';
      filter = filter.toLowerCase();

      if(tabName === 'suggested'){
        if(users.length===0){ listArea.innerHTML = '<div style="padding:12px;color:#8E8E93">No other users found.</div>'; return; }
        users.forEach(u=>{
          if(filter && !(u.displayName || '').toLowerCase().includes(filter) && !(u.bio||'').toLowerCase().includes(filter)) return;
          const isFollowing = follows.some(f => f.followingId === u.id);
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:'<i class="fas fa-user"></i>'}<div class="status ${u.isOnline? '':'offline'}"></div></div>
            <div style="flex:1">
              <div class="info"><h4>${u.displayName||'User'}</h4><p>${(u.bio||'No bio yet').split(' ').slice(0,5).join(' ')}${(u.bio||'').split(' ').length>5?'...':''}</p></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button data-id="${u.id}" class="messageBtn" style="padding:6px 10px;border-radius:8px;background:#34C759;border:none;color:#fff;cursor:pointer">Message</button>
              <button data-id="${u.id}" class="followBtn" style="padding:6px 10px;border-radius:8px;background:${isFollowing? 'transparent':'var(--primary-color)'};border:${isFollowing? '1px solid var(--primary-color)':'none'};color:${isFollowing? 'var(--primary-color)':'#fff'};cursor:pointer">${isFollowing? 'Unfollow':'Follow'}</button>
            </div>
          `;
          listArea.appendChild(el);
        });
        // attach handlers
        listArea.querySelectorAll('.followBtn').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const uid = btn.dataset.id;
            const isFollowing = btn.textContent.trim() === 'Unfollow';
            if(isFollowing) await unfollowUser(uid);
            else await followUser(uid);
          });
        });
        listArea.querySelectorAll('.messageBtn').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const uid = btn.dataset.id;
            const user = users.find(x=>x.id===uid);
            if(user) openChat(uid, user);
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelector('[data-tab="chats"]').classList.add('active');
          });
        });

      } else if(tabName === 'followed'){
        const followed = users.filter(u=> follows.some(f=> f.followingId===u.id));
        if(followed.length===0){ listArea.innerHTML = '<div style="padding:12px;color:#8E8E93">You are not following anyone yet.</div>'; return; }
        followed.forEach(u=>{
          if(filter && !(u.displayName||'').toLowerCase().includes(filter)) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:'<i class="fas fa-user"></i>'}<div class="status ${u.isOnline? '':'offline'}"></div></div>
            <div style="flex:1"><div class="info"><h4>${u.displayName||'User'}</h4><p>${(u.bio||'No bio yet').split(' ').slice(0,5).join(' ')}${(u.bio||'').split(' ').length>5?'...':''}</p></div></div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button data-id="${u.id}" class="msgBtn" style="padding:6px 10px;border-radius:8px;background:#34C759;border:none;color:#fff;cursor:pointer">Message</button>
              <button data-id="${u.id}" class="unfollowBtn" style="padding:6px 10px;border-radius:8px;background:transparent;border:1px solid var(--primary-color);color:var(--primary-color);cursor:pointer">Unfollow</button>
            </div>
          `;
          listArea.appendChild(el);
        });
        // handlers
        listArea.querySelectorAll('.unfollowBtn').forEach(b => b.addEventListener('click', e=> { e.stopPropagation(); unfollowUser(b.dataset.id); }));
        listArea.querySelectorAll('.msgBtn').forEach(b => b.addEventListener('click', e=> { e.stopPropagation(); const u = users.find(x=>x.id===b.dataset.id); if(u) openChat(u.id,u); }));
      } else { // chats
        // Build chat map by other user and latest message
        if(chats.length === 0){
          listArea.innerHTML = '<div style="padding:12px;color:#8E8E93">No conversations yet. Follow users to start chatting!</div>';
          return;
        }
        const map = new Map();
        chats.forEach(c=>{
          const other = c.senderId === currentUser.uid ? c.receiverId : c.senderId;
          const prev = map.get(other);
          if(!prev || (c.timestamp && prev.timestamp && c.timestamp.toMillis() > prev.timestamp.toMillis())){
            map.set(other, { ...c });
          }
        });
        // render
        Array.from(map.keys()).forEach(otherId=>{
          const last = map.get(otherId);
          const u = users.find(x=>x.id===otherId) || { displayName:'Unknown', photoURL:'' };
          if(filter && !((u.displayName||'').toLowerCase().includes(filter) || (last.text||'').toLowerCase().includes(filter))) return;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:'<i class="fas fa-user"></i>'}<div class="status ${u.isOnline? '':'offline'}"></div></div>
            <div style="flex:1"><div class="info"><h4>${u.displayName}</h4><p>${(last.text||'').slice(0,45)}</p></div></div>
            <div style="text-align:right;font-size:12px;color:#8E8E93">${formatTime(last.timestamp)}</div>
          `;
          el.addEventListener('click', ()=> openChat(otherId,u));
          listArea.appendChild(el);
        });
      }
    }

    // Open chat: sets header and loads messages
    function openChat(userId, userObj){
      currentChatUser = { id: userId, ...userObj };
      // header
      chatHeaderAvatar.innerHTML = userObj.photoURL ? `<img src="${userObj.photoURL}">` : `<i class="fas fa-user"></i>`;
      chatHeaderStatus.className = `status ${userObj.isOnline ? '':'offline'}`;
      chatTitle.textContent = userObj.displayName || 'Chat';
      chatSubtitle.textContent = userObj.isOnline ? 'Online' : 'Offline';
      // load messages
      loadChatMessages(userId);
      // focus input
      messageInput.focus();
    }

    // Load messages for conversation
    function loadChatMessages(userId){
      messagesEl.innerHTML = '';
      const convo = chats.filter(m =>
        (m.senderId === currentUser.uid && m.receiverId === userId) ||
        (m.senderId === userId && m.receiverId === currentUser.uid)
      ).sort((a,b)=> {
        const ta = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
        const tb = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
        return ta - tb;
      });

      if(convo.length === 0){
        const div = document.createElement('div'); div.className='msg received'; div.innerHTML = `Start a conversation with ${currentChatUser.displayName}!<div class="meta">Just now</div>`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return;
      }

      convo.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'msg ' + (m.senderId === currentUser.uid ? 'sent' : 'received');
        div.innerHTML = `${escapeHtml(m.text||'')}<div class="meta">${formatTime(m.timestamp)}</div>`;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Send message logic: optimistic UI, safe addDoc, clear input
    async function sendMessage(receiverId){
      const text = messageInput.value.trim();
      if(!text || !currentUser || !receiverId) return;
      // optimistic UI append
      const tempMsg = {
        senderId: currentUser.uid,
        receiverId,
        text,
        timestamp: new Date()
      };
      const div = document.createElement('div');
      div.className = 'msg sent';
      div.innerHTML = `${escapeHtml(text)}<div class="meta">${formatTime(tempMsg.timestamp)}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      messageInput.value = '';
      messageInput.focus();

      try {
        await addDoc(collection(db,'messages'), {
          senderId: currentUser.uid,
          receiverId,
          text,
          timestamp: serverTimestamp()
        });
        // real message will arrive via snapshot listener and replace/merge
      } catch(err){
        console.error('send error',err);
        // optionally show send failure (not added here)
      }
    }

    // Attach send handlers once
    sendBtn.addEventListener('click', ()=> {
      if(currentChatUser) sendMessage(currentChatUser.id);
    });
    messageInput.addEventListener('keydown', (e)=> {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if(currentChatUser) sendMessage(currentChatUser.id);
      }
    });

    // follow/unfollow functions
    async function followUser(userId){
      if(!currentUser) return;
      try{
        await addDoc(collection(db,'follows'), {
          followerId: currentUser.uid,
          followingId: userId,
          timestamp: serverTimestamp()
        });
        // increment follower/following counters safely would require transaction; here we attempt a get/update
        const uRef = doc(db,'users',userId);
        const uSnap = await getDoc(uRef);
        if(uSnap.exists()) await updateDoc(uRef, { followers: (uSnap.data().followers || 0) + 1 }).catch(()=>{});
        const meRef = doc(db,'users',currentUser.uid);
        const meSnap = await getDoc(meRef);
        if(meSnap.exists()) await updateDoc(meRef, { following: (meSnap.data().following || 0) + 1 }).catch(()=>{});
      }catch(e){ console.error(e) }
    }

    async function unfollowUser(userId){
      if(!currentUser) return;
      try{
        const q = query(collection(db,'follows'), where('followerId','==',currentUser.uid), where('followingId','==',userId));
        const snaps = await getDocs(q);
        snaps.forEach(async d => { await deleteDoc(doc(db,'follows',d.id)); });
        // decrement counters
        const uRef = doc(db,'users',userId);
        const uSnap = await getDoc(uRef);
        if(uSnap.exists()) await updateDoc(uRef, { followers: Math.max(0, (uSnap.data().followers || 0) - 1) }).catch(()=>{});
        const meRef = doc(db,'users',currentUser.uid);
        const meSnap = await getDoc(meRef);
        if(meSnap.exists()) await updateDoc(meRef, { following: Math.max(0, (meSnap.data().following || 0) - 1) }).catch(()=>{});
      }catch(e){ console.error(e) }
    }

    // util: escape HTML for safe injection in messages
    function escapeHtml(unsafe) {
      if(!unsafe) return '';
      return unsafe.replace(/[&<"'>]/g, (m)=> {
        switch(m){
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#039;';
          default: return m;
        }
      });
    }

    // small helper to format timestamps used in the list
    function formatTime(ts){
      if(!ts) return '';
      try{
        if(ts.toMillis) return new Date(ts.toMillis()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        if(ts.toDate) return ts.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      }catch{return ''}
    }

    // initialize UI with empty lists
    renderList('chats');

    // Optional: expose a quick sign-in for local dev (uncomment if you want a quick sign-in button)
    // document.body.insertAdjacentHTML('beforeend','<button id="quickSign" style="position:fixed;right:16px;bottom:16px;padding:10px">Sign in (Google)</button>');
    // document.getElementById('quickSign').addEventListener('click', ()=> signInWithPopup(auth,provider).catch(console.error));
  </script>
</body>
</html>
