<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TajibMax Social Chat</title>
  <style>
    :root {
      --bg: #f9f9f9;
      --card: #ffffff;
      --accent: #0077ff;
      --accent-hover: #005fcc;
      --text: #333;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --sidebar-width: 300px;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: white;
      padding: 10px 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title {
      font-weight: 600;
      font-size: 1.5rem;
    }
    .user-menu {
      position: relative;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      width: 150px;
      display: none;
      z-index: 100;
    }
    .dropdown-item {
      padding: 8px;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .dropdown-item:hover {
      background: #f0f0f0;
    }
    .container {
      display: flex;
      flex: 1;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: white;
      border-right: 1px solid #eee;
      padding: 20px;
      overflow-y: auto;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    .contact, .suggested-user {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: var(--radius);
      margin-bottom: 8px;
      cursor: pointer;
    }
    .contact:hover, .suggested-user:hover {
      background: #f5f5f5;
    }
    .contact img, .suggested-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .chat-area {
      flex: 1;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .chat-header {
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    .message {
      margin-bottom: 15px;
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 18px;
    }
    .message.received {
      background: #f0f0f0;
      align-self: flex-start;
    }
    .message.sent {
      background: var(--accent);
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }
    .message-input {
      display: flex;
      margin-top: 15px;
    }
    .message-input input {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #ddd;
      margin-right: 10px;
    }
    .message-input button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      cursor: pointer;
    }
    .message-input button:hover {
      background: var(--accent-hover);
    }
    #loginSection {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }
    #loginBtn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    #loginBtn:hover {
      background: var(--accent-hover);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginSection">
    <h1>TajibMax Social Chat</h1>
    <p>Sign in to start chatting with friends</p>
    <button id="loginBtn">Sign in with Google</button>
  </div>

  <!-- Main App (initially hidden) -->
  <div id="mainApp" class="hidden">
    <header>
      <div class="header-title">TajibMax</div>
      <div class="user-menu" id="userMenu">
        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
        <span id="userName">User Name</span>
        <div class="dropdown" id="dropdown">
          <div class="dropdown-item" id="logoutBtn">Logout</div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="sidebar">
        <h3 class="section-title">Contacts</h3>
        <div id="contactsList"></div>
        
        <h3 class="section-title">Suggested</h3>
        <div id="suggestedList"></div>
      </div>

      <div class="main-content">
        <div class="chat-area">
          <div class="chat-header">
            <h2 id="chatWith">Select a contact to start chatting</h2>
          </div>
          <div class="messages" id="messages"></div>
          <form class="message-input" id="msgForm">
            <input type="text" id="msgInput" placeholder="Type a message..." />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase App (initialized with config) -->
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc, 
      getDocs, 
      collection, 
      query, 
      where, 
      onSnapshot,
      addDoc,
      updateDoc,
      arrayUnion,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDNbhIX7lGndqaE8pGtYScy56gFNluLE8I",
      authDomain: "tajib-max.firebaseapp.com",
      projectId: "tajib-max",
      storageBucket: "tajib-max.firebasestorage.app",
      messagingSenderId: "165946585796",
      appId: "1:165946585796:web:3c438ca3c59ca00f7fcf91",
      measurementId: "G-PP0E1J03YS"
    };

    // --- Init Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const loginSection = document.getElementById('loginSection');
    const loginBtn = document.getElementById('loginBtn');
    const mainApp = document.getElementById('mainApp');
    const userMenu = document.getElementById('userMenu');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const dropdown = document.getElementById('dropdown');
    const logoutBtn = document.getElementById('logoutBtn');
    const contactsList = document.getElementById('contactsList');
    const suggestedList = document.getElementById('suggestedList');
    const messagesDiv = document.getElementById('messages');
    const msgForm = document.getElementById('msgForm');
    const msgInput = document.getElementById('msgInput');
    const chatWith = document.getElementById('chatWith');

    let currentUser = null;
    let activeChatUid = null;
    let unsubscribeChat = null;

    // --- Toggle dropdown menu ---
    userMenu.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking elsewhere
    document.addEventListener('click', () => {
      dropdown.style.display = 'none';
    });

    // --- Login Flow ---
    loginBtn.onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error("Login error:", err.code, err.message);
        alert("Login failed: " + err.message);
      }
    };

    // --- Logout ---
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error("Logout error:", err);
      }
    });

    // --- Auth State Change ---
    onAuthStateChanged(auth, async user => {
      if (!user) {
        // Show login, hide main UI
        loginSection.classList.remove('hidden');
        mainApp.classList.add('hidden');
        return;
      }
      
      currentUser = user;
      
      // Hide login, show main UI
      loginSection.classList.add('hidden');
      mainApp.classList.remove('hidden');
      
      // Update user info in header
      userName.textContent = user.displayName;
      userAvatar.src = user.photoURL;

      // Save/update user in Firestore
      await setDoc(doc(db, "users", user.uid), {
        uid: user.uid,
        name: user.displayName,
        photoURL: user.photoURL,
        friends: []
      }, { merge: true });

      // Load contacts and suggested users
      loadContacts();
      loadSuggestedUsers();
      listenForFriendRequests();
    });

    // --- Load Contacts (friends) ---
    async function loadContacts() {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const friends = userDoc.data()?.friends || [];
      contactsList.innerHTML = '';

      if (friends.length === 0) {
        contactsList.innerHTML = '<p>No contacts yet. Add friends from the suggested list.</p>';
        return;
      }

      for (let uid of friends) {
        const friendDoc = await getDoc(doc(db, "users", uid));
        if (!friendDoc.exists()) continue;
        
        const data = friendDoc.data();
        const contactElement = document.createElement('div');
        contactElement.className = 'contact';
        contactElement.innerHTML = `
          <img src="${data.photoURL}" alt="${data.name}">
          <span>${data.name}</span>
        `;
        contactElement.onclick = () => openChat(uid, data.name);
        contactsList.appendChild(contactElement);
      }
    }

    // --- Load Suggested Users ---
    function loadSuggestedUsers() {
      const q = query(collection(db, "users"));
      onSnapshot(q, snapshot => {
        suggestedList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          // Skip current user and existing friends
          if (data.uid === currentUser.uid) return;
          
          const userElement = document.createElement('div');
          userElement.className = 'suggested-user';
          userElement.innerHTML = `
            <img src="${data.photoURL}" alt="${data.name}">
            <span>${data.name}</span>
          `;
          userElement.onclick = () => sendFriendRequest(data.uid);
          suggestedList.appendChild(userElement);
        });
      });
    }

    // --- Send Friend Request ---
    async function sendFriendRequest(toUid) {
      try {
        await addDoc(collection(db, "friendRequests"), {
          from: currentUser.uid,
          to: toUid,
          status: "pending",
          createdAt: serverTimestamp()
        });
        alert("Friend request sent!");
      } catch (err) {
        console.error("Error sending request:", err);
        alert("Failed to send friend request");
      }
    }

    // --- Listen for Incoming Friend Requests ---
    function listenForFriendRequests() {
      const q = query(
        collection(db, "friendRequests"),
        where("to", "==", currentUser.uid),
        where("status", "==", "pending")
      );
      
      onSnapshot(q, snapshot => {
        snapshot.forEach(async docSnap => {
          const req = docSnap.data();
          
          // Auto-accept friend requests for simplicity
          try {
            await updateDoc(doc(db, "friendRequests", docSnap.id), { status: "accepted" });
            await updateDoc(doc(db, "users", currentUser.uid), { 
              friends: arrayUnion(req.from) 
            });
            await updateDoc(doc(db, "users", req.from), { 
              friends: arrayUnion(currentUser.uid) 
            });
            
            // Refresh contacts list
            loadContacts();
          } catch (err) {
            console.error("Error accepting request:", err);
          }
        });
      });
    }

    // --- Open Chat with Friend ---
    function openChat(uid, name) {
      activeChatUid = uid;
      chatWith.textContent = name;
      messagesDiv.innerHTML = '';

      // Stop previous listener if any
      if (unsubscribeChat) unsubscribeChat();

      const q = query(
        collection(db, "messages"),
        where("participants", "array-contains", currentUser.uid)
      );
      
      unsubscribeChat = onSnapshot(q, snapshot => {
        messagesDiv.innerHTML = '';
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          // Only show messages between these two users
          if (
            (msg.from === currentUser.uid && msg.to === uid) ||
            (msg.from === uid && msg.to === currentUser.uid)
          ) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message ' + 
              (msg.from === currentUser.uid ? 'sent' : 'received');
            messageElement.textContent = msg.text;
            messagesDiv.appendChild(messageElement);
          }
        });
        
        // Scroll to bottom of messages
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // --- Send Message ---
    msgForm.addEventListener('submit', async e => {
      e.preventDefault();
      
      if (!msgInput.value.trim() || !activeChatUid) return;
      
      try {
        await addDoc(collection(db, "messages"), {
          from: currentUser.uid,
          to: activeChatUid,
          participants: [currentUser.uid, activeChatUid],
          text: msgInput.value,
          createdAt: serverTimestamp()
        });
        msgInput.value = '';
      } catch (err) {
        console.error("Error sending message:", err);
        alert("Failed to send message");
      }
    });
  </script>
</body>
</html>
