<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Message — Landing & Login Flow</title>
  <style>
    :root{--bg:#ffffff;--panel:#f7f7fb;--primary:#0a84ff;--muted:#8e8e93;--text:#111;--glass:rgba(0,0,0,0.04);--bubble-me:var(--primary);--bubble-other:#e5e6ea}
    [data-theme="dark"]{--bg:#0b1020;--panel:#0f1726;--primary:#4aa3ff;--muted:#9aa4b2;--text:#e8eef8;--bubble-me:#2b6cff;--bubble-other:#172033;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .full{height:100vh;display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:920px;margin:20px;border-radius:14px;background:var(--panel);box-shadow:0 6px 24px rgba(0,0,0,0.06);overflow:hidden;display:flex}
    /* Landing column */
    .left{flex:1;padding:36px;min-width:320px}
    .right{width:360px;border-left:1px solid var(--glass);padding:22px;display:flex;flex-direction:column;gap:12px}
    h1{margin:0 0 6px 0;font-size:20px}
    p.lead{margin:0 0 18px 0;color:var(--muted)}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--glass);cursor:pointer;background:transparent}
    .primary{background:var(--primary);color:#fff;border:none}
    .small{font-size:13px;color:var(--muted)}
    /* App layout (hidden until signed in) */
    .app{display:flex;flex-direction:column;height:100vh;max-width:980px;margin:0 auto;border-left:1px solid var(--glass);border-right:1px solid var(--glass)}
    header{display:flex;align-items:center;gap:12px;padding:10px 14px}
    .main{display:flex;flex:1;overflow:hidden}
    .col{flex-basis:320px;flex-shrink:0;border-right:1px solid var(--glass);background:var(--panel);overflow:auto}
    .col.full{flex:1;border-right:none;background:transparent}
    .list{padding:12px;display:flex;flex-direction:column;gap:10px}
    .user-row{display:flex;align-items:center;gap:12px;padding:8px;border-radius:10px;cursor:pointer}
    .avatar{width:44px;height:44px;border-radius:50%;background:#bbb;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .chat-wrap{display:flex;flex-direction:column;height:100%}
    .messages{flex:1;padding:20px 14px 120px;display:flex;flex-direction:column;gap:10px;overflow:auto}
    .msg{max-width:74%;padding:10px 12px;border-radius:16px;word-wrap:break-word}
    .msg.me{margin-left:auto;background:linear-gradient(180deg,var(--bubble-me),#0077e6);color:white}
    .msg.other{margin-right:auto;background:var(--bubble-other);color:var(--text)}
    .composer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:transparent;display:flex;justify-content:center}
    .composer-inner{width:100%;max-width:980px;padding:10px 14px;background:var(--panel);display:flex;gap:8px;border-top:1px solid var(--glass)}
    .text{flex:1;padding:10px 12px;border-radius:999px;border:1px solid var(--glass);background:transparent;color:var(--text);outline:none}
    .hidden{display:none}
    @media(max-width:900px){ .card{flex-direction:column} .right{width:100%;border-left:none;border-top:1px solid var(--glass)} }
  </style>
</head>
<body data-theme="light">

  <!-- LANDING / LOGIN SCREEN (always shown first) -->
  <div id="landing" class="full">
    <div class="card" role="dialog" aria-labelledby="landing-title" aria-describedby="landing-desc">
      <div class="left">
        <h1 id="landing-title">Mini Message</h1>
        <p class="lead" id="landing-desc">Real-time, minimal messaging with profiles and following. Sign in to continue.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button id="btn-google" class="btn primary">Sign in with Google</button>
          <button id="btn-anon" class="btn">Quick Start (Anonymous)</button>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid var(--glass)" />
        <div class="small">Already have an account? Use Google above. Guests can try anonymous mode. Every session starts here.</div>

        <div id="landing-note" class="small" style="margin-top:18px;color:var(--muted)"></div>
      </div>

      <div class="right">
        <div style="font-weight:700">Why Mini Message</div>
        <div class="small">Clean iMessage-style UI · Follow users · Real-time messaging via Firebase</div>
        <div style="flex:1"></div>
        <div class="small" style="text-align:center">By signing in you agree to store your profile and messages on Firebase for this app demo.</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP (hidden until auth transition completes) -->
  <div id="app" class="app hidden" aria-hidden="true">
    <header>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(180deg,var(--primary),#006fe6)"></div>
        <div style="font-weight:700">Mini Message</div>
      </div>
      <div style="flex:1"></div>
      <div id="auth-area" style="display:flex;gap:8px;align-items:center"></div>
    </header>

    <div class="main">
      <div class="col" id="left-col">
        <div style="padding:12px;display:flex;align-items:center;gap:8px"><div class="small">Chats</div></div>
        <div id="chats-list" class="list"></div>
      </div>

      <div class="col full" id="chat-col">
        <div id="chat-empty" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)">
          <div style="text-align:center;max-width:360px">
            <h3 style="margin:0 0 8px 0">No conversation selected</h3>
            <div class="small">Select someone to start messaging</div>
          </div>
        </div>

        <div class="chat-wrap hidden" id="chat-wrap" aria-live="polite">
          <div style="padding:12px;border-bottom:1px solid var(--glass);display:flex;align-items:center;gap:12px">
            <div id="chat-avatar" class="avatar">U</div>
            <div>
              <div id="chat-name" style="font-weight:700">User</div>
              <div id="chat-bio" class="small"></div>
            </div>
            <div style="flex:1"></div>
          </div>

          <div id="messages" class="messages" tabindex="0"></div>
        </div>
      </div>
    </div>

    <div class="composer" aria-hidden="false">
      <div class="composer-inner">
        <input id="text-input" class="text" placeholder="Message" />
        <button id="send-btn" class="btn primary">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvaWRvpDY-BOOg_oitS4oVGDoQkiWMR6A",
      authDomain: "windowsassistant-36760.firebaseapp.com",
      projectId: "windowsassistant-36760",
      storageBucket: "windowsassistant-36760.firebasestorage.app",
      messagingSenderId: "125638102938",
      appId: "1:125638102938:web:42e36690e0b74096003423"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Utilities
    const $ = s => document.querySelector(s);
    const create = (t,cls)=>{ const e=document.createElement(t); if(cls) e.className=cls; return e; };
    const escapeHtml = s => (s+'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const conversationId = (a,b) => [a,b].sort().join('_');
    const nowTs = () => serverTimestamp();

    // DOM
    const landing = $('#landing'), appEl = $('#app');
    const btnGoogle = $('#btn-google'), btnAnon = $('#btn-anon'), landingNote = $('#landing-note');
    const authArea = $('#auth-area');
    const chatsList = $('#chats-list');
    const chatWrap = $('#chat-wrap'), chatEmpty = $('#chat-empty');
    const messagesEl = $('#messages'), chatName = $('#chat-name'), chatBio = $('#chat-bio'), chatAvatar = $('#chat-avatar');
    const sendBtn = $('#send-btn'), textInput = $('#text-input');

    // In-memory state
    let me = null;
    let usersCache = {};
    let followsCache = new Set();
    let activePeer = null;
    let messagesUnsub = null;
    let usersUnsub = null;
    let followsUnsub = null;

    // Ensure profile exists server-side and return profile
    async function ensureProfile(user){
      const uRef = doc(db,'users',user.uid);
      const snap = await getDoc(uRef);
      if(!snap.exists()){
        const base = { uid:user.uid, displayName: user.displayName || `User${user.uid.slice(0,6)}`, bio:'', createdAt: nowTs(), theme:'light' };
        await setDoc(uRef, base);
        usersCache[user.uid] = base;
        return base;
      } else {
        usersCache[user.uid] = snap.data();
        return snap.data();
      }
    }

    // Streamlined sign-in flows
    btnGoogle.onclick = async ()=>{ try{ const p = new GoogleAuthProvider(); await signInWithPopup(auth,p); } catch(e){ console.error(e); alert('Google sign-in failed'); } };
    btnAnon.onclick = async ()=>{ try{ await signInAnonymously(auth); } catch(e){ console.error(e); alert('Anonymous sign-in failed'); } };

    // Render landing page (always first). If a previous session exists, landing shows a short status then auto-continues.
    let initialAuthHandled = false;
    onAuthStateChanged(auth, async user => {
      // This callback fires on page load and on sign-in/out
      if(!initialAuthHandled){
        // First auth event after load: we want landing visible first.
        // If user already signed in (Firebase persisted), detect and auto-proceed after brief note.
        if(user){
          landingNote.textContent = 'Detected previous sign-in, restoring your session…';
          try{
            const profile = await ensureProfile(user);
            me = {...profile, uid: user.uid};
            // Small delay so user sees landing status (feel free to remove)
            setTimeout(()=>enterApp(), 700);
          } catch(e){
            console.error('restore failed', e);
            landingNote.textContent = 'Could not restore session. Please sign in.';
          }
        } else {
          // No signed-in user: show landing and wait for explicit sign-in
          landingNote.textContent = '';
          landing.style.display = 'flex';
          appEl.classList.add('hidden');
        }
        initialAuthHandled = true;
        return;
      }

      // Subsequent auth changes (sign-in or sign-out) should transition appropriately:
      if(user){
        // Signed in (after user clicks sign-in)
        try{
          const profile = await ensureProfile(user);
          me = {...profile, uid:user.uid};
          enterApp();
        } catch(e){
          console.error('ensureProfile error', e);
          alert('Sign-in succeeded but failed to load profile');
        }
      } else {
        // Signed out: return to landing and clear all memory and listeners
        await signOutCleanupUI();
      }
    });

    // Enter main app UI after successful sign-in
    function enterApp(){
      // Hide landing, show app
      landing.style.display = 'none';
      appEl.classList.remove('hidden');
      appEl.setAttribute('aria-hidden','false');
      renderAuthArea();
      initAppForUser();
    }

    // Render compact auth area (avatar + sign out)
    function renderAuthArea(){
      authArea.innerHTML = '';
      const av = create('div','avatar'); av.textContent = (me.displayName||'U')[0].toUpperCase();
      const name = create('div'); name.textContent = me.displayName || 'You'; name.style.marginLeft='8px';
      const wrap = create('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
      wrap.appendChild(av); wrap.appendChild(name);
      const signOutBtn = create('button','btn'); signOutBtn.textContent = 'Sign out';
      signOutBtn.onclick = async ()=>{ try{ await signOut(auth); } catch(e){ console.error('signout', e); } };
      authArea.appendChild(wrap); authArea.appendChild(signOutBtn);
    }

    // Clean UI + memory and show landing again
    async function signOutCleanupUI(){
      // Unsubscribe listeners
      if(messagesUnsub){ messagesUnsub(); messagesUnsub = null; }
      if(usersUnsub){ usersUnsub(); usersUnsub = null; }
      if(followsUnsub){ followsUnsub(); followsUnsub = null; }

      // Clear memory-only caches and UI state
      me = null;
      usersCache = {};
      followsCache = new Set();
      activePeer = null;
      chatsList.innerHTML = '';
      messagesEl.innerHTML = '';
      chatName.textContent = 'User';
      chatBio.textContent = '';
      chatAvatar.textContent = 'U';
      chatWrap.classList.add('hidden');
      chatEmpty.style.display = 'flex';

      // Show landing again
      landing.style.display = 'flex';
      appEl.classList.add('hidden');
      landingNote.textContent = '';
    }

    // Initialize app features for signed-in user: subscribe users + follows
    function initAppForUser(){
      // Subscribe to users collection (in-memory only)
      usersUnsub = onSnapshot(collection(db,'users'), snap => {
        usersCache = {};
        snap.forEach(s => { const u = s.data(); usersCache[u.uid] = u; });
        delete usersCache[me.uid];
        renderChatsList();
      }, err => console.error('users subscription', err));

      // Subscribe to follows for preview/chat list
      followsUnsub = onSnapshot(query(collection(db,'follows'), where('followerId','==', me.uid)), snap => {
        followsCache = new Set();
        snap.forEach(s => followsCache.add(s.data().followingId));
        renderChatsList();
      }, err => console.error('follows subscription', err));

      // Wire send
      sendBtn.onclick = sendMessage;
      textInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });
    }

    // Render chat list (follows prioritized)
    function renderChatsList(){
      chatsList.innerHTML = '';
      const uids = followsCache.size ? Array.from(followsCache) : Object.keys(usersCache).filter(id => id !== me.uid);
      if(uids.length === 0){ chatsList.innerHTML = '<div class="small">No chats yet</div>'; return; }
      uids.forEach(uid => {
        const u = usersCache[uid]; if(!u) return;
        const row = create('div','user-row');
        const av = create('div','avatar'); av.textContent = (u.displayName||'U')[0].toUpperCase();
        const body = create('div'); body.style.flex = '1';
        const name = create('div'); name.style.fontWeight='700'; name.textContent = u.displayName || 'User';
        const meta = create('div'); meta.className='small'; meta.textContent = u.bio || '';
        body.appendChild(name); body.appendChild(meta);
        row.appendChild(av); row.appendChild(body);
        row.onclick = ()=>openChatWith(u);
        chatsList.appendChild(row);
      });
    }

    // Messaging subscribe for convo (single active subscription at a time)
    function subscribeToConversation(peerUid){
      if(messagesUnsub){ messagesUnsub(); messagesUnsub = null; }
      const convo = conversationId(me.uid, peerUid);
      messagesEl.innerHTML = '<div class="small">Loading messages…</div>';
      messagesUnsub = onSnapshot(query(collection(db,'messages'), where('conversationId','==', convo), orderBy('timestamp','asc')), snap => {
        messagesEl.innerHTML = '';
        snap.forEach(d => {
          const m = d.data();
          if(m.deleted) return;
          const el = create('div','msg ' + (m.senderId === me.uid ? 'me' : 'other'));
          el.innerHTML = `<div>${escapeHtml(m.text || '')}</div><div class="small">${m.timestamp ? formatTimestamp(m.timestamp) : ''}${m.senderId===me.uid ? ' · You' : ''}</div>`;
          if(m.senderId === me.uid){
            el.ondblclick = async ()=>{ if(confirm('Delete this message?')) await deleteMessage(d.id); };
          }
          messagesEl.appendChild(el);
        });
        requestAnimationFrame(()=> messagesEl.scrollTop = messagesEl.scrollHeight);
      }, err => console.error('messages subscription', err));
    }

    function openChatWith(u){
      activePeer = u;
      chatEmpty.style.display = 'none';
      chatWrap.classList.remove('hidden');
      chatName.textContent = u.displayName || 'User';
      chatBio.textContent = u.bio || '';
      chatAvatar.textContent = (u.displayName||'U')[0].toUpperCase();
      subscribeToConversation(u.uid);
    }

    async function sendMessage(){
      const text = textInput.value.trim();
      if(!text) return;
      if(!activePeer){ alert('Select recipient'); return; }
      if(!followsCache.has(activePeer.uid)){ alert('You can only message users you follow'); return; }
      const convo = conversationId(me.uid, activePeer.uid);
      try{
        await addDoc(collection(db,'messages'), {
          conversationId: convo,
          senderId: me.uid,
          receiverId: activePeer.uid,
          text,
          timestamp: nowTs(),
          deleted: false
        });
        textInput.value = '';
      } catch(e){
        console.error('send failed', e);
        alert('Failed to send message');
      }
    }

    async function deleteMessage(messageId){
      try{ await updateDoc(doc(db,'messages',messageId), { deleted: true }); } catch(e){ console.error(e); }
    }

    function formatTimestamp(ts){
      if(!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
    }

    // Boot: show landing; onAuthStateChanged will auto-restore if session persisted
    (function boot(){
      landing.style.display = 'flex';
      appEl.classList.add('hidden');
    })();
  </script>
</body>
</html>
