<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TajibMax Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --primary: #007AFF;
            --primary-dark: #0066CC;
            --background: #F7F7F7;
            --card-bg: #FFFFFF;
            --text-primary: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: #E5E5EA;
            --accent: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --story-border: linear-gradient(45deg, #FCAF45, #833AB4, #405DE6);
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #FCB045 100%);
            color: white;
            text-align: center;
            padding: 20px;
        }

        .login-logo {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .login-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .login-btn {
            background: white;
            color: #405DE6;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }

        /* Main App */
        .app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .app-logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-status {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            width: 200px;
            padding: 10px 0;
            z-index: 100;
            display: none;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Main Content */
        .app-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--background);
            border-radius: 10px;
            padding: 10px 15px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 5px;
            outline: none;
            font-size: 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .contacts-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .contact {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .contact-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
            border: 2px solid var(--border);
        }

        .contact-avatar::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            top: 0;
            left: 0;
            padding: 2px;
            background: var(--story-border);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
        }

        .contact.has-story .contact-avatar::after {
            opacity: 1;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .contact-lastmsg {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .contact-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .contact-badge {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="white"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(0,0,0,0.03)" stroke-width="1"/></svg>');
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .chat-user {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            font-size: 0.95rem;
        }

        .message.received {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.sent {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 0.65rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .message-input-container {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            gap: 12px;
        }

        .message-input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 10px 18px;
            outline: none;
            font-size: 0.95rem;
        }

        .attachment-btn, .send-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--primary);
            cursor: pointer;
        }

        /* Suggested Contacts */
        .suggested-section {
            padding: 15px;
            border-top: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .see-all {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: normal;
        }

        .suggested-contacts {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 5px 0;
        }

        .suggested-contact {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .suggested-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
            border: 2px solid var(--border);
        }

        .suggested-avatar::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            top: 0;
            left: 0;
            padding: 2px;
            background: var(--story-border);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            mask-composite: exclude;
        }

        .suggested-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .add-contact {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 0.8rem;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .setting-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .setting-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            
            .contact-info, .contact-meta, .contact-name, .contact-lastmsg {
                display: none;
            }
            
            .tab span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">
            <i class="fab fa-instagram"></i>
        </div>
        <h1 class="login-title">TajibMax Messenger</h1>
        <p class="login-subtitle">Connect with friends and the world around you</p>
        <button class="login-btn" id="loginBtn">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="app-header">
            <div class="app-logo">TajibMax</div>
            <div class="user-profile" id="userProfile">
                <img src="" class="user-avatar" id="userAvatar" alt="User Avatar">
                <div class="user-info">
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-status">Online</div>
                </div>
                <i class="fas fa-chevron-down"></i>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item" id="profileBtn">
                        <i class="fas fa-user"></i> Profile
                    </div>
                    <div class="dropdown-item" id="settingsBtn">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                    <div class="dropdown-item" id="appearanceBtn">
                        <i class="fas fa-moon"></i> Appearance
                    </div>
                    <div class="dropdown-item" id="helpBtn">
                        <i class="fas fa-question-circle"></i> Help
                    </div>
                    <div class="dropdown-item" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="app-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search messages or users" id="searchInput">
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active"><i class="fas fa-comment"></i> <span>Messages</span></div>
                    <div class="tab"><i class="fas fa-user-friends"></i> <span>Contacts</span></div>
                    <div class="tab"><i class="fas fa-bell"></i> <span>Notifications</span></div>
                </div>

                <div class="contacts-container" id="contactsContainer">
                    <!-- Contacts will be populated here -->
                </div>

                <div class="suggested-section">
                    <div class="section-title">
                        Suggested Contacts <span class="see-all">See All</span>
                    </div>
                    <div class="suggested-contacts" id="suggestedContacts">
                        <!-- Suggested contacts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-user">
                        <img src="" class="user-avatar" id="chatAvatar" alt="Chat User">
                        <div class="user-info">
                            <div class="user-name" id="chatUserName">Select a contact to start chatting</div>
                            <div class="user-status" id="chatUserStatus">Online</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn"><i class="fas fa-phone"></i></button>
                        <button class="chat-action-btn"><i class="fas fa-video"></i></button>
                        <button class="chat-action-btn"><i class="fas fa-info-circle"></i></button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be populated here -->
                    <div class="welcome-message">
                        <p>Welcome to TajibMax Messenger! Select a contact to start chatting.</p>
                    </div>
                </div>

                <div class="message-input-container">
                    <button class="attachment-btn"><i class="fas fa-plus-circle"></i></button>
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message...">
                    <button class="send-btn" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-modal" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <h3 class="setting-title">Notifications</h3>
                    <p class="setting-description">Enable or disable message notifications</p>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <h3 class="setting-title">Sound</h3>
                    <p class="setting-description">Play sounds for new messages</p>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <h3 class="setting-title">Dark Mode</h3>
                    <p class="setting-description">Switch to dark theme</p>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Your Profile</h2>
                <button class="close-modal" id="closeProfile">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="" id="profileAvatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;">
                    <h2 id="profileName" style="margin-bottom: 5px;">User Name</h2>
                    <p id="profileEmail" style="color: var(--text-secondary);">user@example.com</p>
                </div>
                <div class="setting-item">
                    <h3 class="setting-title">Status</h3>
                    <p class="setting-description">Set your online status</p>
                    <select id="statusSelect" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); width: 100%;">
                        <option value="online">Online</option>
                        <option value="away">Away</option>
                        <option value="busy">Busy</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase App (initialized with config) -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            collection, 
            query, 
            where, 
            onSnapshot,
            addDoc,
            updateDoc,
            arrayUnion,
            serverTimestamp,
            orderBy,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNbhIX7lGndqaE8pGtYScy56gFNluLE8I",
            authDomain: "tajib-max.firebaseapp.com",
            projectId: "tajib-max",
            storageBucket: "tajib-max.firebasestorage.app",
            messagingSenderId: "165946585796",
            appId: "1:165946585796:web:3c438ca3c59ca00f7fcf91",
            measurementId: "G-PP0E1J03YS"
        };

        // --- Init Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const userProfile = document.getElementById('userProfile');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileBtn = document.getElementById('profileBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const appearanceBtn = document.getElementById('appearanceBtn');
        const helpBtn = document.getElementById('helpBtn');
        const contactsContainer = document.getElementById('contactsContainer');
        const suggestedContacts = document.getElementById('suggestedContacts');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatUserName = document.getElementById('chatUserName');
        const chatAvatar = document.getElementById('chatAvatar');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const profileModal = document.getElementById('profileModal');
        const closeProfile = document.getElementById('closeProfile');
        const profileName = document.getElementById('profileName');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileEmail = document.getElementById('profileEmail');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const statusSelect = document.getElementById('statusSelect');

        // App state
        let currentUser = null;
        let activeChat = null;
        let unsubscribeChat = null;
        let contacts = [];
        let suggestedUsers = [];

        // --- Login Flow ---
        loginBtn.onclick = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (err) {
                console.error("Login error:", err.code, err.message);
                alert("Login failed: " + err.message);
            }
        };

        // --- Logout ---
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (err) {
                console.error("Logout error:", err);
            }
        });

        // --- User profile dropdown ---
        userProfile.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
        });

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', () => {
            dropdownMenu.style.display = 'none';
        });

        // --- Modal controls ---
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        profileBtn.addEventListener('click', () => {
            profileModal.style.display = 'flex';
        });

        closeProfile.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (e.target === profileModal) {
                profileModal.style.display = 'none';
            }
        });

        // --- Dark mode toggle ---
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            // You would typically save this preference to local storage or user profile
        });

        // --- Status change ---
        statusSelect.addEventListener('change', () => {
            // Update user status in Firebase
            console.log("Status changed to:", statusSelect.value);
        });

        // --- Auth State Change ---
        onAuthStateChanged(auth, async user => {
            if (!user) {
                // Show login, hide main UI
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                return;
            }
            
            currentUser = user;
            
            // Hide login, show main UI
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            
            // Update user info in header
            userName.textContent = user.displayName;
            userAvatar.src = user.photoURL;
            
            // Update profile modal
            profileName.textContent = user.displayName;
            profileAvatar.src = user.photoURL;
            profileEmail.textContent = user.email;

            // Save/update user in Firestore
            await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                status: "online",
                friends: [],
                lastSeen: serverTimestamp()
            }, { merge: true });

            // Load contacts and suggested users
            loadContacts();
            loadSuggestedUsers();
            listenForFriendRequests();
        });

        // --- Load Contacts (friends) ---
        async function loadContacts() {
            const userDoc = await getDoc(doc(db, "users", currentUser.uid));
            const friends = userDoc.data()?.friends || [];
            contactsContainer.innerHTML = '';

            if (friends.length === 0) {
                contactsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">No contacts yet. Add friends from the suggested list.</p>';
                return;
            }

            for (let uid of friends) {
                const friendDoc = await getDoc(doc(db, "users", uid));
                if (!friendDoc.exists()) continue;
                
                const data = friendDoc.data();
                const contactElement = document.createElement('div');
                contactElement.className = 'contact';
                contactElement.dataset.uid = data.uid;
                contactElement.innerHTML = `
                    <img src="${data.photoURL}" class="contact-avatar" alt="${data.name}">
                    <div class="contact-info">
                        <div class="contact-name">${data.name}</div>
                        <div class="contact-lastmsg">Last message will appear here</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">12:30 PM</div>
                        <div class="contact-badge">3</div>
                    </div>
                `;
                contactElement.addEventListener('click', () => openChat(data.uid, data.name, data.photoURL));
                contactsContainer.appendChild(contactElement);
                contacts.push(data);
            }
        }

        // --- Load Suggested Users ---
        async function loadSuggestedUsers() {
            const querySnapshot = await getDocs(collection(db, "users"));
            suggestedContacts.innerHTML = '';
            suggestedUsers = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Skip current user and existing friends
                if (data.uid === currentUser.uid || 
                    (currentUser && currentUser.friends && currentUser.friends.includes(data.uid))) return;
                
                suggestedUsers.push(data);
                
                const userElement = document.createElement('div');
                userElement.className = 'suggested-contact';
                userElement.innerHTML = `
                    <div class="suggested-avatar">
                        <img src="${data.photoURL}" alt="${data.name}">
                        <button class="add-contact">+</button>
                    </div>
                    <div class="suggested-name">${data.name}</div>
                `;
                userElement.addEventListener('click', () => sendFriendRequest(data.uid));
                suggestedContacts.appendChild(userElement);
            });
        }

        // --- Send Friend Request ---
        async function sendFriendRequest(toUid) {
            try {
                await addDoc(collection(db, "friendRequests"), {
                    from: currentUser.uid,
                    to: toUid,
                    status: "pending",
                    createdAt: serverTimestamp()
                });
                alert("Friend request sent!");
            } catch (err) {
                console.error("Error sending request:", err);
                alert("Failed to send friend request");
            }
        }

        // --- Listen for Incoming Friend Requests ---
        function listenForFriendRequests() {
            const q = query(
                collection(db, "friendRequests"),
                where("to", "==", currentUser.uid),
                where("status", "==", "pending")
            );
            
            onSnapshot(q, snapshot => {
                snapshot.forEach(async docSnap => {
                    const req = docSnap.data();
                    
                    // Auto-accept friend requests for simplicity
                    try {
                        await updateDoc(doc(db, "friendRequests", docSnap.id), { status: "accepted" });
                        await updateDoc(doc(db, "users", currentUser.uid), { 
                            friends: arrayUnion(req.from) 
                        });
                        await updateDoc(doc(db, "users", req.from), { 
                            friends: arrayUnion(currentUser.uid) 
                        });
                        
                        // Refresh contacts list
                        loadContacts();
                        loadSuggestedUsers();
                    } catch (err) {
                        console.error("Error accepting request:", err);
                    }
                });
            });
        }

        // --- Open Chat with Friend ---
        function openChat(uid, name, avatar) {
            activeChat = uid;
            chatUserName.textContent = name;
            chatAvatar.src = avatar;
            messagesContainer.innerHTML = '';

            // Stop previous listener if any
            if (unsubscribeChat) unsubscribeChat();

            const q = query(
                collection(db, "messages"),
                where("participants", "array-contains", currentUser.uid),
                orderBy("createdAt", "asc")
            );
            
            unsubscribeChat = onSnapshot(q, snapshot => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    // Only show messages between these two users
                    if (
                        (msg.from === currentUser.uid && msg.to === uid) ||
                        (msg.from === uid && msg.to === currentUser.uid)
                    ) {
                        addMessageToChat(msg, msg.from === currentUser.uid);
                    }
                });
                
                // Scroll to bottom of messages
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // --- Add message to chat UI ---
        function addMessageToChat(message, isSent) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            messageEl.classList.add(isSent ? 'sent' : 'received');
            
            // Format timestamp
            let timeText = '';
            if (message.createdAt) {
                const date = message.createdAt.toDate();
                timeText = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            messageEl.innerHTML = `
                ${message.text}
                <div class="message-time">${timeText}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
        }

        // --- Send Message ---
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || !activeChat) return;
            
            try {
                await addDoc(collection(db, "messages"), {
                    from: currentUser.uid,
                    to: activeChat,
                    participants: [currentUser.uid, activeChat],
                    text: messageText,
                    createdAt: serverTimestamp()
                });
                messageInput.value = '';
                
                // Simulate reply after a short delay
                setTimeout(() => {
                    simulateReply();
                }, 1000 + Math.random() * 2000);
            } catch (err) {
                console.error("Error sending message:", err);
                alert("Failed to send message");
            }
        }

        // --- Simulate reply from other user ---
        async function simulateReply() {
            if (!activeChat) return;
            
            try {
                // Get the active chat user's data
                const userDoc = await getDoc(doc(db, "users", activeChat));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                // Only simulate reply if this is not the current user
                if (userData.uid !== currentUser.uid) {
                    const replies = [
                        "Hey there! How's it going?",
                        "That's interesting! Tell me more.",
                        "I've been thinking about that too.",
                        "Thanks for sharing that with me.",
                        "I appreciate your perspective.",
                        "Let's catch up soon!",
                        "What are your plans for the weekend?",
                        "I saw that too, it was amazing!",
                        "I'll get back to you on that.",
                        "Sounds good to me!"
                    ];
                    
                    const replyMessage = replies[Math.floor(Math.random() * replies.length)];
                    
                    await addDoc(collection(db, "messages"), {
                        from: activeChat,
                        to: currentUser.uid,
                        participants: [currentUser.uid, activeChat],
                        text: replyMessage,
                        createdAt: serverTimestamp()
                    });
                }
            } catch (err) {
                console.error("Error simulating reply:", err);
            }
        }
    </script>
</body>
</html>
