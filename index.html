<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>iMessage Social</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-color: #007AFF;
  --secondary-color: #5856D6;
  --bg-color: #F2F2F7;
  --card-bg: rgba(255, 255, 255, 0.8);
  --text-color: #1C1C1E;
  --border-radius: 20px;
  --shadow: 0 12px 48px rgba(31, 38, 135, 0.37);
  --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --glass-bg: rgba(255, 255, 255, 0.25);
  --glass-border: rgba(255, 255, 255, 0.18);
}
[data-theme="dark"] {
  --bg-color: #000000;
  --card-bg: rgba(30, 30, 30, 0.7);
  --text-color: #FFFFFF;
  --glass-bg: rgba(30, 30, 30, 0.5);
  --glass-border: rgba(255, 255, 255, 0.1);
}
/* Liquid glass updated to requested style */
[data-theme="liquid"] {
  --bg-color: radial-gradient(1200px 600px at 10% 20%, rgba(102,126,234,0.20) 0%, rgba(118,75,162,0.12) 20%, rgba(118,75,162,0.08) 40%, rgba(255,255,255,0) 100%), linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --card-bg: rgba(255, 255, 255, 0.06);
  --text-color: #FFFFFF;
  --glass-bg: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
  --glass-border: rgba(255,255,255,0.08);
  --shadow: 0 12px 40px rgba(20,18,50,0.45);
}
[data-theme="sunset"] {
  --bg-color: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
  --card-bg: rgba(255, 255, 255, 0.2);
  --text-color: #FFFFFF;
  --glass-bg: rgba(255, 255, 255, 0.15);
  --glass-border: rgba(255, 255, 255, 0.25);
}
[data-theme="forest"] {
  --bg-color: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
  --card-bg: rgba(255, 255, 255, 0.15);
  --text-color: #FFFFFF;
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
}
* {
  margin: 0; padding: 0; box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}
body {
  background: var(--bg-color);
  color: var(--text-color);
  transition: var(--transition);
  min-height: 100vh;
  overflow-x: hidden;
}
/* Login Screen */
.login-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100vh; padding: 20px; text-align: center; animation: fadeIn 0.8s ease-out;
}
@keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
.login-card {
  background: var(--glass-bg); backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border); border-radius: var(--border-radius);
  padding: 40px; box-shadow: var(--shadow); max-width: 400px; width: 100%;
  transform: translateY(0); transition: var(--transition);
}
.login-card:hover { transform: translateY(-5px); box-shadow: 0 20px 60px rgba(31,38,135,0.5); }
.app-logo {
  font-size: 48px; margin-bottom: 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 2s infinite;
}
@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
.app-title {
  font-size: 32px; font-weight: 700; margin-bottom: 10px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.app-subtitle { font-size: 16px; margin-bottom: 30px; color: #8E8E93; }
.login-btn {
  display:flex; align-items:center; justify-content:center; gap:10px;
  width:100%; padding:15px; border-radius:15px; border:none; background:#4285F4; color:white;
  font-weight:600; font-size:16px; cursor:pointer; transition: var(--transition); margin-bottom:20px;
  position:relative; overflow:hidden;
}
.login-btn::after { content:''; position:absolute; top:50%; left:50%; width:5px; height:5px; background:rgba(255,255,255,0.5); opacity:0; border-radius:100%; transform: scale(1,1) translate(-50%); transform-origin:50% 50%; }
.login-btn:hover::after { animation: ripple 1s ease-out; }
@keyframes ripple { 0%{ transform:scale(0,0); opacity:0.5;} 100%{ transform:scale(20,20); opacity:0; } }
.login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(66,133,244,0.3); }
.login-btn i { font-size: 20px; }
/* App Container */
.app-container {
  display:none; height:100vh; max-width:1200px; margin:0 auto; padding:20px; gap:20px; animation: fadeIn 0.5s ease-out;
}
/* Profile Card - Collapsible */
.profile-card {
  position:absolute; top:20px; right:20px; width:60px; height:60px;
  background: var(--glass-bg); backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border); border-radius:50%;
  padding:0; box-shadow: var(--shadow); z-index:100; transition: var(--transition);
  overflow:hidden; cursor:pointer;
}
.profile-card.expanded { width:240px; height:auto; border-radius: var(--border-radius); padding:20px; }
.profile-header { display:flex; align-items:center; margin-bottom:15px; opacity:0; transition: opacity 0.3s ease; }
.profile-card.expanded .profile-header { opacity:1; }
.profile-pic {
  width:60px; height:60px; border-radius:50%;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display:flex; align-items:center; justify-content:center; color:white; font-size:24px;
  margin-right:15px; overflow:hidden; flex-shrink:0; transition: var(--transition); position:relative;
}
.profile-card:not(.expanded) .profile-pic { margin-right:0; width:100%; height:100%; }
.profile-pic img { width:100%; height:100%; object-fit:cover; }
.status-indicator { position:absolute; bottom:2px; right:2px; width:14px; height:14px; border-radius:50%; background:#34C759; border:2px solid var(--card-bg); z-index:10; }
.status-indicator.offline { background: #8E8E93; }
.profile-info { overflow:hidden; }
.profile-info h3 { font-size:18px; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.profile-info p { font-size:14px; color:#8E8E93; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.profile-stats { display:flex; justify-content:space-between; margin:15px 0; font-size:14px; opacity:0; transition: opacity 0.3s ease; }
.profile-card.expanded .profile-stats { opacity:1; }
.profile-actions { display:flex; gap:10px; opacity:0; transition: opacity 0.3s ease; }
.profile-card.expanded .profile-actions { opacity:1; }
.btn {
  padding:8px 15px; border-radius:10px; border:none; background: var(--primary-color); color:white; font-weight:500; cursor:pointer; transition: var(--transition); flex:1; position:relative; overflow:hidden;
}
.btn::after { content:''; position:absolute; top:50%; left:50%; width:5px; height:5px; background:rgba(255,255,255,0.5); opacity:0; border-radius:100%; transform: scale(1,1) translate(-50%); transform-origin:50% 50%; }
.btn:hover::after { animation: ripple 1s ease-out; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,122,255,0.3); }
.btn-outline { background:transparent; border:1px solid var(--primary-color); color: var(--primary-color); }
/* Theme Selector */
.theme-selector {
  position:absolute; top:20px; left:20px; width:50px; height:50px; border-radius:50%;
  background: var(--glass-bg); backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border); display:flex; align-items:center; justify-content:center; cursor:pointer;
  box-shadow: var(--shadow); z-index:100; transition: var(--transition); overflow:hidden;
}
.theme-selector.expanded { width:200px; border-radius:25px; padding:0 10px; }
.theme-options { display:flex; gap:8px; opacity:0; width:0; transition: opacity 0.3s ease, width 0.3s ease; }
.theme-selector.expanded .theme-options { opacity:1; width:auto; }
.theme-option { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: var(--transition); font-size:14px; }
.theme-option:hover { transform: scale(1.1); }
.theme-option.active { transform: scale(1.15); box-shadow: 0 0 0 2px var(--text-color); }
.theme-light { background:#F2F2F7; color:#1C1C1E; }
.theme-dark { background:#000000; color:#FFFFFF; }
.theme-liquid { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#FFFFFF; }
.theme-sunset { background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%); color:#FFFFFF; }
.theme-forest { background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); color:#FFFFFF; }
.theme-icon { transition: var(--transition); }
.theme-selector.expanded .theme-icon { opacity:0; width:0; }
/* Sidebar */
.sidebar {
  width:300px; background: var(--glass-bg); backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border); border-radius: var(--border-radius);
  padding:20px; box-shadow: var(--shadow); display:flex; flex-direction:column;
  transform: translateX(0); transition: var(--transition);
}
.app-title-bar {
  font-size:24px; font-weight:700; margin-bottom:20px; text-align:center;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.tabs { display:flex; margin-bottom:20px; background: rgba(255,255,255,0.2); border-radius:15px; padding:5px; }
.tab { flex:1; text-align:center; padding:10px; border-radius:10px; cursor:pointer; transition: var(--transition); font-size:12px; }
.tab.active { background: var(--primary-color); color:white; transform: scale(1.05); }
.search-box {
  padding:12px; border-radius:15px; border:1px solid var(--glass-border);
  background: rgba(255,255,255,0.3); margin-bottom:20px; width:100%; color: var(--text-color); transition: var(--transition);
}
.search-box:focus { outline:none; box-shadow: 0 0 0 2px var(--primary-color); }
.chat-list, .user-list, .followed-list { flex:1; overflow-y:auto; }
.chat-item, .user-item {
  display:flex; align-items:center; padding:15px; border-radius:15px; margin-bottom:10px; cursor:pointer; transition: var(--transition); animation: slideIn 0.3s ease-out; position:relative;
}
@keyframes slideIn { from{opacity:0; transform: translateX(-10px);} to{opacity:1; transform: translateX(0);} }
.chat-item:hover, .user-item:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
.chat-item.active { background: rgba(0,122,255,0.2); }
.chat-avatar, .user-avatar {
  width:50px; height:50px; border-radius:50%;
  background: linear-gradient(135deg, #5856D6, #007AFF);
  display:flex; align-items:center; justify-content:center; color:white; font-size:18px; margin-right:15px; overflow:hidden; flex-shrink:0; position:relative;
}
.chat-avatar img, .user-avatar img { width:100%; height:100%; object-fit:cover; }
.chat-avatar .status-indicator, .user-avatar .status-indicator { width:12px; height:12px; bottom:2px; right:2px; }
.chat-info, .user-info { flex:1; min-width:0; }
.chat-info h4, .user-info h4 { font-size:16px; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.last-message { font-size:14px; color:#8E8E93; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.user-actions { display:flex; gap:8px; }
.follow-btn, .message-btn {
  padding:6px 12px; border-radius:10px; border:none; background: var(--primary-color); color:white; font-size:12px; cursor:pointer; transition: var(--transition); position:relative; overflow:hidden;
}
.follow-btn::after, .message-btn::after { content:''; position:absolute; top:50%; left:50%; width:5px; height:5px; background:rgba(255,255,255,0.5); opacity:0; border-radius:100%; transform: scale(1,1) translate(-50%); transform-origin:50% 50%; }
.follow-btn:hover::after, .message-btn:hover::after { animation: ripple 1s ease-out; }
.follow-btn:hover, .message-btn:hover { transform: translateY(-2px); box-shadow: 0 3px 10px rgba(0,122,255,0.3); }
.follow-btn.following { background:transparent; border:1px solid var(--primary-color); color: var(--primary-color); }
.message-btn { background:#34C759; }
/* Chat Area */
.chat-area {
  flex:1; display:flex; flex-direction:column; background: var(--glass-bg); backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow:hidden; transform: translateY(0); transition: var(--transition);
}
.chat-header { padding:20px; border-bottom:1px solid var(--glass-border); display:flex; align-items:center; }
.chat-header-avatar {
  width:40px; height:40px; border-radius:50%; background: linear-gradient(135deg, #FF2D55, #FF9500);
  display:flex; align-items:center; justify-content:center; color:white; font-size:16px; margin-right:15px; overflow:hidden; flex-shrink:0; position:relative;
}
.chat-header-avatar img { width:100%; height:100%; object-fit:cover; }
.chat-header-avatar .status-indicator { width:10px; height:10px; bottom:1px; right:1px; }
.chat-messages { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; }
.message {
  max-width:70%; padding:12px 16px; border-radius:18px; margin-bottom:10px; position:relative; word-wrap:break-word; animation: messageAppear 0.3s ease-out;
}
@keyframes messageAppear { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
.message.sent { align-self:flex-end; background: var(--primary-color); color:white; border-bottom-right-radius:5px; }
.message.received { align-self:flex-start; background:#E5E5EA; color:black; border-bottom-left-radius:5px; }
.message-time { font-size:11px; margin-top:5px; text-align:right; opacity:0.7; }

/* Delivery indicators */
.message-status {
  font-size:11px; margin-top:4px; text-align:right; opacity:0.8; color:rgba(255,255,255,0.9);
}
.message.sent .message-status .tick {
  display:inline-block; margin-left:4px;
}
.message.sent.sending { opacity:0.85; }
.message.sent.sending .message-status { color:rgba(255,255,255,0.8); }
.message.sent.delivered .message-status { color:#cfe9ff; }

.message-input-container { padding:20px; border-top:1px solid var(--glass-border); display:flex; gap:10px; }
.message-input {
  flex:1; padding:12px 20px; border-radius:20px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.3); color: var(--text-color); transition: var(--transition);
}
.message-input:focus { outline:none; box-shadow: 0 0 0 2px var(--primary-color); }
.send-btn {
  width:44px; height:44px; border-radius:50%; border:none; background: var(--primary-color); color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: var(--transition); position:relative; overflow:hidden;
}
.send-btn::after { content:''; position:absolute; top:50%; left:50%; width:5px; height:5px; background:rgba(255,255,255,0.5); opacity:0; border-radius:100%; transform: scale(1,1) translate(-50%); transform-origin:50% 50%; }
.send-btn:hover::after { animation: ripple 1s ease-out; }
.send-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,122,255,0.3); }
/* Edit Profile Modal */
.modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index:1000; align-items:center; justify-content:center; animation: fadeIn 0.3s ease-out;
}
.modal-content {
  background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--border-radius);
  padding:30px; width:90%; max-width:500px; box-shadow: var(--shadow); transform: scale(0.9); animation: modalAppear 0.3s ease-out forwards;
}
@keyframes modalAppear { to{ transform:scale(1);} }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.modal-title { font-size:20px; font-weight:600; }
.close-btn { background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-color); transition: var(--transition); }
.close-btn:hover { transform: rotate(90deg); }
.form-group { margin-bottom:20px; }
.form-group label { display:block; margin-bottom:8px; font-weight:500; }
.form-control {
  width:100%; padding:12px; border-radius:10px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.3); color: var(--text-color); transition: var(--transition);
}
.form-control:focus { outline:none; box-shadow: 0 0 0 2px var(--primary-color); }
/* Responsive */
@media (max-width: 768px) {
  .app-container { flex-direction:column; padding:10px; }
  .sidebar { width:100%; height:40%; }
  .chat-area { height:60%; }
  .profile-card { position:relative; top:0; right:0; width:100%; height:auto; border-radius: var(--border-radius); margin-bottom:20px; }
  .profile-card.expanded { width:100%; }
  .theme-selector.expanded { width:180px; }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="app-logo">
      <i class="fas fa-comments"></i>
    </div>
    <h1 class="app-title">iMessage Social</h1>
    <p class="app-subtitle">Connect with friends in real-time</p>
    <button class="login-btn" id="googleSignInBtn">
      <i class="fab fa-google"></i>
      Sign in with Google
    </button>
    <p class="app-subtitle">Sign in to start messaging</p>
  </div>
</div>

<!-- Main App -->
<div class="app-container" id="appContainer">
  <div class="theme-selector" id="themeSelector">
    <div class="theme-icon"><i class="fas fa-palette"></i></div>
    <div class="theme-options">
      <div class="theme-option theme-light active" data-theme="light" title="Light Mode"><i class="fas fa-sun"></i></div>
      <div class="theme-option theme-dark" data-theme="dark" title="Dark Mode"><i class="fas fa-moon"></i></div>
      <div class="theme-option theme-liquid" data-theme="liquid" title="Liquid Glass"><i class="fas fa-glass-whiskey"></i></div>
      <div class="theme-option theme-sunset" data-theme="sunset" title="Sunset"><i class="fas fa-sun"></i></div>
      <div class="theme-option theme-forest" data-theme="forest" title="Forest"><i class="fas fa-tree"></i></div>
    </div>
  </div>

  <div class="profile-card" id="profileCard">
    <div class="profile-header">
      <div class="profile-pic" id="profilePic">
        <i class="fas fa-user"></i>
        <div class="status-indicator" id="profileStatus"></div>
      </div>
      <div class="profile-info">
        <h3 id="profileName">Loading...</h3>
        <p id="profileBio">Bio will appear here</p>
      </div>
    </div>
    <div class="profile-stats">
      <div>
        <div class="stat-number" id="followerCount">0</div>
        <div class="stat-label">Followers</div>
      </div>
      <div>
        <div class="stat-number" id="followingCount">0</div>
        <div class="stat-label">Following</div>
      </div>
    </div>
    <div class="profile-actions">
      <button class="btn" id="editProfileBtn">Edit Profile</button>
      <button class="btn btn-outline" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="app-title-bar">iMessage Social</div>
    <div class="tabs">
      <div class="tab active" data-tab="chats">üí¨ Chats</div>
      <div class="tab" data-tab="suggested">üë• Suggested</div>
      <div class="tab" data-tab="followed">‚ù§Ô∏è Followed</div>
      <div class="tab" data-tab="me">üôç‚Äç‚ôÇÔ∏è Me</div>
    </div>
    <input type="text" class="search-box" placeholder="Search...">
    <div class="chat-list" id="chatList"></div>
    <div class="user-list" id="userList" style="display: none;"></div>
    <div class="followed-list" id="followedList" style="display: none;"></div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <div class="chat-header-avatar">
        <i class="fas fa-user-friends"></i>
        <div class="status-indicator offline"></div>
      </div>
      <div>
        <h3 id="chatHeaderTitle">Select a conversation</h3>
        <p id="chatHeaderSubtitle">Start chatting with friends</p>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message received">
        Welcome to iMessage Social! Select a conversation to start messaging.
        <div class="message-time">Just now</div>
      </div>
    </div>

    <div class="message-input-container">
      <input type="text" class="message-input" placeholder="Type a message...">
      <button class="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Edit Profile</h3>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    <div class="form-group">
      <label for="editName">Display Name</label>
      <input type="text" id="editName" class="form-control" placeholder="Your display name" maxlength="30">
    </div>
    <div class="form-group">
      <label for="editBio">Bio (max 10 words)</label>
      <textarea id="editBio" class="form-control" rows="3" placeholder="Tell others about yourself (max 10 words)" maxlength="100"></textarea>
      <small style="color: #8E8E93; font-size: 12px;">Words remaining: <span id="wordCount">10</span></small>
    </div>
    <button class="btn" id="saveProfileBtn">Save Changes</button>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
import {
  getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, where, orderBy, updateDoc, doc, setDoc, getDoc, getDocs, deleteDoc, limit
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCvaWRvpDY-BOOg_oitS4oVGDoQkiWMR6A",
  authDomain: "windowsassistant-36760.firebaseapp.com",
  projectId: "windowsassistant-36760",
  storageBucket: "windowsassistant-36760.firebasestorage.app",
  messagingSenderId: "125638102938",
  appId: "1:125638102938:web:42e36690e0b74096003423"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// DOM
const loginScreen = document.getElementById('loginScreen');
const appContainer = document.getElementById('appContainer');
const googleSignInBtn = document.getElementById('googleSignInBtn');
const themeSelector = document.getElementById('themeSelector');
const profileCard = document.getElementById('profileCard');
const profilePic = document.getElementById('profilePic');
const profileName = document.getElementById('profileName');
const profileBio = document.getElementById('profileBio');
const profileStatus = document.getElementById('profileStatus');
const followerCount = document.getElementById('followerCount');
const followingCount = document.getElementById('followingCount');
const editProfileBtn = document.getElementById('editProfileBtn');
const logoutBtn = document.getElementById('logoutBtn');
const tabs = document.querySelectorAll('.tab');
const chatList = document.getElementById('chatList');
const userList = document.getElementById('userList');
const followedList = document.getElementById('followedList');
const chatMessages = document.getElementById('chatMessages');
const editProfileModal = document.getElementById('editProfileModal');
const closeModal = document.getElementById('closeModal');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const editName = document.getElementById('editName');
const editBio = document.getElementById('editBio');
const wordCount = document.getElementById('wordCount');
let messageInput = document.querySelector('.message-input');
let sendBtn = document.querySelector('.send-btn');
const themeOptions = document.querySelectorAll('.theme-option');
const chatHeaderTitle = document.getElementById('chatHeaderTitle');
const chatHeaderSubtitle = document.getElementById('chatHeaderSubtitle');

// State
let currentUser = null;
let currentTheme = 'light';
let users = [];
let chats = [];
let follows = [];
let currentChatUser = null;
let _convoUnsubSender = null;
let _convoUnsubReceiver = null;
let __sendHandler = null;
let __keyHandler = null;

// Helpers
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return String(unsafe).replace(/[&<"'>]/g, (m) => {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#039;';
      default: return m;
    }
  });
}

// Profile card hover
let profileCardTimeout;
profileCard.addEventListener('mouseenter', () => {
  clearTimeout(profileCardTimeout);
  profileCard.classList.add('expanded');
});
profileCard.addEventListener('mouseleave', () => {
  profileCardTimeout = setTimeout(() => {
    profileCard.classList.remove('expanded');
  }, 300);
});

// Theme selector hover
let themeSelectorTimeout;
themeSelector.addEventListener('mouseenter', () => {
  clearTimeout(themeSelectorTimeout);
  themeSelector.classList.add('expanded');
});
themeSelector.addEventListener('mouseleave', () => {
  themeSelectorTimeout = setTimeout(() => {
    themeSelector.classList.remove('expanded');
  }, 300);
});

// Theme selection
themeOptions.forEach(option => {
  option.addEventListener('click', () => {
    const theme = option.dataset.theme;
    setTheme(theme);
    themeOptions.forEach(opt => opt.classList.remove('active'));
    option.classList.add('active');
  });
});

// Bio word count
editBio.addEventListener('input', () => {
  const words = editBio.value.trim().split(/\s+/).filter(w => w.length > 0);
  const wordLimit = 10;
  const remaining = wordLimit - words.length;
  wordCount.textContent = Math.max(0, remaining);
  if (remaining < 0) {
    wordCount.style.color = '#FF3B30';
    editBio.value = words.slice(0, wordLimit).join(' ');
    wordCount.textContent = 0;
  } else {
    wordCount.style.color = '#8E8E93';
  }
});

// Google Sign-In
googleSignInBtn.addEventListener('click', () => {
  signInWithPopup(auth, provider)
    .then((result) => { console.log('User signed in:', result.user); })
    .catch((error) => { console.error('Sign-in error:', error); });
});

// Tabs
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    if (tab.dataset.tab === 'chats') {
      chatList.style.display = 'block';
      userList.style.display = 'none';
      followedList.style.display = 'none';
      loadChats();
    } else if (tab.dataset.tab === 'suggested') {
      chatList.style.display = 'none';
      userList.style.display = 'block';
      followedList.style.display = 'none';
      loadUsers();
    } else if (tab.dataset.tab === 'followed') {
      chatList.style.display = 'none';
      userList.style.display = 'none';
      followedList.style.display = 'block';
      loadFollowedUsers();
    } else if (tab.dataset.tab === 'me') {
      chatList.style.display = 'block';
      userList.style.display = 'none';
      followedList.style.display = 'none';
    }
  });
});

// Modal
editProfileBtn.addEventListener('click', () => {
  editName.value = profileName.textContent;
  editBio.value = profileBio.textContent;
  const words = editBio.value.trim().split(/\s+/).filter(w => w.length > 0);
  wordCount.textContent = Math.max(0, 10 - words.length);
  editProfileModal.style.display = 'flex';
});
closeModal.addEventListener('click', () => { editProfileModal.style.display = 'none'; });
saveProfileBtn.addEventListener('click', () => {
  const newName = editName.value;
  let newBio = editBio.value;
  const words = newBio.trim().split(/\s+/).filter(w => w.length > 0);
  if (words.length > 10) newBio = words.slice(0, 10).join(' ');
  profileName.textContent = newName;
  profileBio.textContent = newBio;
  if (currentUser) updateUserProfile(currentUser.uid, newName, newBio);
  editProfileModal.style.display = 'none';
});

// Logout
logoutBtn.addEventListener('click', async () => {
  if (currentUser) {
    await updateUserOnlineStatus(currentUser.uid, false).catch(()=>{});
  }
  if (_convoUnsubSender) { _convoUnsubSender(); _convoUnsubSender = null; }
  if (_convoUnsubReceiver) { _convoUnsubReceiver(); _convoUnsubReceiver = null; }
  signOut(auth).then(() => {
    currentUser = null;
    loginScreen.style.display = 'flex';
    appContainer.style.display = 'none';
  }).catch((error) => { console.error('Logout error:', error); });
});

// Auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    console.log('User signed in:', user);
    loginScreen.style.display = 'none';
    appContainer.style.display = 'flex';
    updateUserOnlineStatus(user.uid, true);
    checkAndCreateUserProfile(user);
    loadUserTheme(user.uid);
    setupFirestoreListeners(user.uid);
    updateProfileUI(user);
  } else {
    loginScreen.style.display = 'flex';
    appContainer.style.display = 'none';
  }
});

// Theme
function setTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute('data-theme', theme);
  if (currentUser) updateUserTheme(currentUser.uid, theme);
}

// Firestore profile funcs
async function checkAndCreateUserProfile(user) {
  const userDocRef = doc(db, 'users', user.uid);
  const userDoc = await getDoc(userDocRef);
  if (!userDoc.exists()) {
    await setDoc(userDocRef, {
      displayName: user.displayName || `User${Math.floor(1000 + Math.random() * 9000)}`,
      bio: 'Hello! I am using iMessage Social.',
      photoURL: user.photoURL || '',
      followers: 0,
      following: 0,
      isOnline: true,
      lastSeen: serverTimestamp(),
      createdAt: serverTimestamp(),
      theme: 'light'
    });
  } else {
    const userData = userDoc.data();
    profileName.textContent = userData.displayName;
    profileBio.textContent = userData.bio;
    followerCount.textContent = userData.followers || 0;
    followingCount.textContent = userData.following || 0;
    if (userData.photoURL) {
      profilePic.innerHTML = `<img src="${userData.photoURL}" alt="Profile"><div class="status-indicator" id="profileStatus"></div>`;
    }
    if (userData.isOnline) profileStatus.classList.remove('offline');
    else profileStatus.classList.add('offline');
  }
}
async function updateUserProfile(uid, displayName, bio) {
  const userDocRef = doc(db, 'users', uid);
  await updateDoc(userDocRef, { displayName, bio });
}
async function updateUserTheme(uid, theme) {
  const userDocRef = doc(db, 'users', uid);
  await updateDoc(userDocRef, { theme });
}
async function updateUserOnlineStatus(uid, isOnline) {
  const userDocRef = doc(db, 'users', uid);
  await updateDoc(userDocRef, { isOnline, lastSeen: serverTimestamp() });
}
async function loadUserTheme(uid) {
  const userDocRef = doc(db, 'users', uid);
  const userDoc = await getDoc(userDocRef);
  if (userDoc.exists()) {
    const userData = userDoc.data();
    if (userData.theme) {
      setTheme(userData.theme);
      themeOptions.forEach(opt => {
        if (opt.dataset.theme === userData.theme) opt.classList.add('active');
        else opt.classList.remove('active');
      });
    }
  }
}

// Global listeners
function setupFirestoreListeners(uid) {
  // Users
  const usersQuery = collection(db, 'users');
  onSnapshot(usersQuery, (snapshot) => {
    users = [];
    snapshot.forEach(docSnap => {
      if (docSnap.id !== uid) users.push({ id: docSnap.id, ...docSnap.data() });
    });
    loadUsers();
    loadFollowedUsers();
  });

  // Follows
  const followsQueryRef = query(collection(db, 'follows'), where('followerId', '==', uid));
  onSnapshot(followsQueryRef, (snapshot) => {
    follows = [];
    snapshot.forEach(docSnap => { follows.push({ id: docSnap.id, ...docSnap.data() }); });
    followingCount.textContent = follows.length;
    loadUsers();
    loadFollowedUsers();
  });

  // My profile updates (followers count)
  const userDocRef = doc(db, 'users', uid);
  onSnapshot(userDocRef, (docSnap) => {
    if (docSnap.exists()) {
      const userData = docSnap.data();
      followerCount.textContent = userData.followers || 0;
    }
  });
}

function updateProfileUI(user) {
  profileName.textContent = user.displayName || 'User';
  if (user.photoURL) {
    profilePic.innerHTML = `<img src="${user.photoURL}" alt="Profile"><div class="status-indicator" id="profileStatus"></div>`;
  }
}

// Lists
function loadUsers() {
  userList.innerHTML = '';
  if (users.length === 0) {
    userList.innerHTML = '<div class="user-item">No other users found.</div>';
    return;
  }
  users.forEach(user => {
    const isFollowing = follows.some(f => f.followingId === user.id);
    const shortBio = user.bio ? user.bio.split(' ').slice(0, 5).join(' ') + (user.bio.split(' ').length > 5 ? '...' : '') : 'No bio yet';
    const userElement = document.createElement('div');
    userElement.className = 'user-item';
    userElement.innerHTML = `
      <div class="user-avatar">
        ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : '<i class="fas fa-user"></i>'}
        <div class="status-indicator ${user.isOnline ? '' : 'offline'}"></div>
      </div>
      <div class="user-info">
        <h4>${user.displayName}</h4>
        <p>${shortBio}</p>
      </div>
      <div class="user-actions">
        ${isFollowing
          ? `<button class="message-btn" data-userid="${user.id}">Message</button>
             <button class="follow-btn following" data-userid="${user.id}">Unfollow</button>`
          : `<button class="follow-btn" data-userid="${user.id}">Follow</button>`
        }
      </div>
    `;
    userList.appendChild(userElement);
  });

  document.querySelectorAll('.follow-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const userId = button.dataset.userid;
      const isFollowing = button.classList.contains('following');
      if (isFollowing) unfollowUser(userId);
      else followUser(userId);
    });
  });

  document.querySelectorAll('.message-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const userId = button.dataset.userid;
      const user = users.find(u => u.id === userId);
      if (user) {
        openChat(userId, user);
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tab="chats"]').classList.add('active');
        chatList.style.display = 'block';
        userList.style.display = 'none';
        followedList.style.display = 'none';
      }
    });
  });
}

function loadFollowedUsers() {
  followedList.innerHTML = '';
  const followedUsers = users.filter(user => follows.some(follow => follow.followingId === user.id));
  if (followedUsers.length === 0) {
    followedList.innerHTML = '<div class="user-item">You are not following anyone yet.</div>';
    return;
  }
  followedUsers.forEach(user => {
    const shortBio = user.bio ? user.bio.split(' ').slice(0, 5).join(' ') + (user.bio.split(' ').length > 5 ? '...' : '') : 'No bio yet';
    const userElement = document.createElement('div');
    userElement.className = 'user-item';
    userElement.innerHTML = `
      <div class="user-avatar">
        ${user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : '<i class="fas fa-user"></i>'}
        <div class="status-indicator ${user.isOnline ? '' : 'offline'}"></div>
      </div>
      <div class="user-info">
        <h4>${user.displayName}</h4>
        <p>${shortBio}</p>
      </div>
      <div class="user-actions">
        <button class="message-btn" data-userid="${user.id}">Message</button>
        <button class="follow-btn following" data-userid="${user.id}">Unfollow</button>
      </div>
    `;
    followedList.appendChild(userElement);
  });

  document.querySelectorAll('.follow-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const userId = button.dataset.userid;
      unfollowUser(userId);
    });
  });

  document.querySelectorAll('.message-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const userId = button.dataset.userid;
      const user = users.find(u => u.id === userId);
      if (user) {
        openChat(userId, user);
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tab="chats"]').classList.add('active');
        chatList.style.display = 'block';
        userList.style.display = 'none';
        followedList.style.display = 'none';
      }
    });
  });
}

function loadChats() {
  chatList.innerHTML = '';
  const listed = new Map();
  follows.forEach(f => {
    const u = users.find(x => x.id === f.followingId);
    if (u) listed.set(u.id, { user: u, lastMessage: 'Say hi!' });
  });

  // Recent messages to surface chats quickly (limited for speed)
  const recentQuery = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(100));
  onSnapshot(recentQuery, (snap) => {
    snap.docs.forEach(d => {
      const m = { id: d.id, ...d.data() };
      if (!currentUser) return;
      const other = m.senderId === currentUser.uid ? m.receiverId : m.senderId;
      if (!other) return;
      if (!listed.has(other)) {
        const u = users.find(x => x.id === other);
        listed.set(other, { user: u || null, lastMessage: m.text || '' });
      } else {
        const entry = listed.get(other);
        entry.lastMessage = entry.lastMessage || m.text;
        listed.set(other, entry);
      }
    });

    if (listed.size === 0) {
      chatList.innerHTML = '<div class="chat-item">No conversations yet. Follow users to start chatting!</div>';
      return;
    }
    chatList.innerHTML = '';
    listed.forEach((val, userId) => {
      const chatElement = document.createElement('div');
      chatElement.className = 'chat-item';
      chatElement.innerHTML =
        `<div class="chat-avatar">
           ${val.user && val.user.photoURL ? `<img src="${val.user.photoURL}">` : '<i class="fas fa-user"></i>'}
           <div class="status-indicator ${val.user && val.user.isOnline ? '' : 'offline'}"></div>
         </div>
         <div class="chat-info">
           <h4>${val.user ? val.user.displayName : 'Unknown User'}</h4>
           <p class="last-message">${escapeHtml(val.lastMessage || '')}</p>
         </div>`;
      chatElement.addEventListener('click', () => openChat(userId, val.user || { displayName: 'Unknown User' }));
      chatList.appendChild(chatElement);
    });
  }, err => { console.error(err); });
}

// Chat open with per-convo listeners
function openChat(userId, user) {
  if (_convoUnsubSender) { _convoUnsubSender(); _convoUnsubSender = null; }
  if (_convoUnsubReceiver) { _convoUnsubReceiver(); _convoUnsubReceiver = null; }

  currentChatUser = { id: userId, ...user };

  const headerAvatar = document.querySelector('.chat-header-avatar');
  headerAvatar.innerHTML = user && user.photoURL ? `<img src="${user.photoURL}" alt="${user.displayName}">` : '<i class="fas fa-user"></i>';
  const indicator = headerAvatar.querySelector('.status-indicator') || document.createElement('div');
  indicator.className = 'status-indicator ' + ((user && user.isOnline) ? '' : 'offline');
  headerAvatar.appendChild(indicator);

  chatHeaderTitle.textContent = user ? user.displayName : 'Unknown User';
  chatHeaderSubtitle.textContent = (user && user.isOnline) ? 'Online' : 'Offline';

  chatMessages.innerHTML = `<div class="message received">Loading messages...<div class="message-time">Just now</div></div>`;

  const convoMap = new Map();

  // Include local writes for instant appearance
  const snapshotOpts = { includeMetadataChanges: true };

  // My messages to them
  const qA = query(
    collection(db, 'messages'),
    where('senderId', '==', currentUser.uid),
    where('receiverId', '==', userId),
    orderBy('createdAt', 'asc')
  );
  _convoUnsubSender = onSnapshot(qA, snapshotOpts, snap => {
    snap.forEach(ds => convoMap.set(ds.id, { id: ds.id, ...ds.data() }));
    renderConversationFromMap(convoMap);
  }, err => console.error('convo sender listen error', err));

  // Their messages to me
  const qB = query(
    collection(db, 'messages'),
    where('senderId', '==', userId),
    where('receiverId', '==', currentUser.uid),
    orderBy('createdAt', 'asc')
  );
  _convoUnsubReceiver = onSnapshot(qB, snapshotOpts, snap => {
    snap.forEach(ds => {
      const data = { id: ds.id, ...ds.data() };
      convoMap.set(ds.id, data);
      // Mark delivered when I receive it
      if (data.senderId === userId && data.receiverId === currentUser.uid && data.status !== 'delivered') {
        updateDoc(doc(db, 'messages', ds.id), { status: 'delivered' }).catch(()=>{});
      }
    });
    renderConversationFromMap(convoMap);
  }, err => console.error('convo receiver listen error', err));

  bindSendHandlerForConversation(userId);
}

function renderConversationFromMap(map) {
  const arr = Array.from(map.values()).sort((a, b) => {
    const ta = (typeof a.createdAt === 'number') ? a.createdAt : 0;
    const tb = (typeof b.createdAt === 'number') ? b.createdAt : 0;
    return ta - tb;
  });

  chatMessages.innerHTML = '';
  if (arr.length === 0) {
    chatMessages.innerHTML = `<div class="message received">Start a conversation with ${currentChatUser ? currentChatUser.displayName : 'this user'}!<div class="message-time">Just now</div></div>`;
  } else {
    arr.forEach(m => {
      const div = document.createElement('div');
      const isMine = m.senderId === currentUser.uid;
      div.className = 'message ' + (isMine ? 'sent' : 'received');

      const tsDate = m.timestamp && m.timestamp.toDate ? m.timestamp.toDate() : new Date(m.createdAt || Date.now());
      const timeStr = tsDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const statusHtml = isMine ? buildStatusHtml(m.status) : '';
      div.innerHTML = `
        ${escapeHtml(m.text || '')}
        <div class="message-time">${timeStr}</div>
        ${isMine ? `<div class="message-status">${statusHtml}</div>` : ''}
      `;

      // styling class for state
      if (isMine) {
        if (m.status === 'sending') div.classList.add('sending');
        else if (m.status === 'delivered') div.classList.add('delivered');
      }

      chatMessages.appendChild(div);
    });
  }
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function buildStatusHtml(status) {
  // ‚åõ sending, ‚úì sent, ‚úì‚úì delivered
  if (status === 'delivered') return `<span class="tick">‚úì‚úì</span>`;
  if (status === 'sent') return `<span class="tick">‚úì</span>`;
  return `<span class="tick">‚åõ</span>`;
}

// Send handlers
function bindSendHandlerForConversation(receiverId) {
  if (__sendHandler) sendBtn.removeEventListener('click', __sendHandler);
  if (__keyHandler) messageInput.removeEventListener('keypress', __keyHandler);
  __sendHandler = () => sendMessage(receiverId);
  __keyHandler = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(receiverId); } };
  sendBtn.addEventListener('click', __sendHandler);
  messageInput.addEventListener('keypress', __keyHandler);
}

async function sendMessage(receiverId) {
  const messageText = (messageInput.value || '').trim();
  if (!messageText || !currentUser) return;
  try {
    // Create with local-first ordering and status
    const msgRef = await addDoc(collection(db, 'messages'), {
      senderId: currentUser.uid,
      receiverId: receiverId,
      text: messageText,
      // local-first order key
      createdAt: Date.now(),
      // server authoritative timestamp (may come later)
      timestamp: serverTimestamp(),
      // delivery state: sending -> sent -> delivered
      status: 'sending'
    });

    // After write acknowledged by client, mark as 'sent'
    await updateDoc(doc(db, 'messages', msgRef.id), { status: 'sent' }).catch(()=>{});

    // Clear input
    messageInput.value = '';
  } catch (error) {
    console.error('Error sending message:', error);
  }
}

// Follow system
async function followUser(userId) {
  if (!currentUser) return;
  try {
    await addDoc(collection(db, 'follows'), {
      followerId: currentUser.uid,
      followingId: userId,
      timestamp: serverTimestamp()
    });
    const userDocRef = doc(db, 'users', userId);
    const userDoc = await getDoc(userDocRef);
    if (userDoc.exists()) {
      const userData = userDoc.data();
      await updateDoc(userDocRef, { followers: (userData.followers || 0) + 1 });
    }
    const currentUserDocRef = doc(db, 'users', currentUser.uid);
    const currentUserDoc = await getDoc(currentUserDocRef);
    if (currentUserDoc.exists()) {
      const currentUserData = currentUserDoc.data();
      await updateDoc(currentUserDocRef, { following: (currentUserData.following || 0) + 1 });
    }
  } catch (error) {
    console.error('Error following user:', error);
  }
}

async function unfollowUser(userId) {
  if (!currentUser) return;
  try {
    const followsQueryRef = query(
      collection(db, 'follows'),
      where('followerId', '==', currentUser.uid),
      where('followingId', '==', userId)
    );
    const querySnapshot = await getDocs(followsQueryRef);
    querySnapshot.forEach(async (followDoc) => {
      await deleteDoc(doc(db, 'follows', followDoc.id));
    });

    const userDocRef = doc(db, 'users', userId);
    const userDoc = await getDoc(userDocRef);
    if (userDoc.exists()) {
      const userData = userDoc.data();
      await updateDoc(userDocRef, { followers: Math.max(0, (userData.followers || 0) - 1) });
    }

    const currentUserDocRef = doc(db, 'users', currentUser.uid);
    const currentUserDoc = await getDoc(currentUserDocRef);
    if (currentUserDoc.exists()) {
      const currentUserData = currentUserDoc.data();
      await updateDoc(currentUserDocRef, { following: Math.max(0, (currentUserData.following || 0) - 1) });
    }
  } catch (error) {
    console.error('Error unfollowing user:', error);
  }
}

// Init theme
document.body.setAttribute('data-theme', 'light');
</script>
</body>
</html>
